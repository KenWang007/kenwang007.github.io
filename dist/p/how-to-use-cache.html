<!DOCTYPE html>
<html lang="zh-CN" class="page-article">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    <meta name="keywords" content="æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    <meta name="author" content="Ken Wang">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <meta property="og:title" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“">
    <meta property="og:description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <meta property="twitter:title" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“">
    <meta property="twitter:description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6366f1">
    
    <title>ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="/style.css?v=2.1.2">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%236366f1%22>ğŸ“š</text></svg>">
    <link rel="canonical" href="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <link rel="manifest" href="/manifest.json">
    
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Kençš„çŸ¥è¯†åº“ RSS Feed" href="/rss.xml">
    
    <!-- Breadcrumb Navigation -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "é¦–é¡µ",
          "item": "https://kenwang007.github.io/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
          "item": "https://kenwang007.github.io/dist/p/how-to-use-cache.html"
        }
      ]
    }
    </script>
    
    <!-- Article Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
      "description": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
      "author": {
        "@type": "Person",
        "name": "Ken Wang"
      },
      "datePublished": "2026-01-29T20:26:18.620163",
      "dateModified": "2026-01-29T20:26:18.620163",
      "inLanguage": "zh-CN"
    }
    </script>
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="stars3"></div>

    <!-- é¡¶éƒ¨å›ºå®šå¯¼èˆª -->
    <header class="top-nav">
        <div class="nav-container">
            <div class="logo">
                <a href="/index.html">
                    <span class="logo-text">ğŸ“š Kençš„çŸ¥è¯†åº“</span>
                </a>
            </div>
            <nav class="main-nav">
                <ul id="nav-menu" class="nav-menu">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªèœå•é¡¹ -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- å·¦ä¾§å›ºå®šå…³é”®è¯ç´¢å¼• -->
        <aside class="keyword-sidebar">
            <div class="keyword-header">
                <h3>å…³é”®è¯ç´¢å¼•</h3>
            </div>
            <div class="keyword-list" id="keyword-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å…³é”®è¯ -->
            </div>
        </aside>

        <!-- ä¸­é—´ä¸»å†…å®¹ -->
        <section class="content-area">
            <div class="content-wrapper">
                <article class="markdown-content">
                    
<h1 id="è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ</h1>
<blockquote>
<p>â€œThere are only two hard things in Computer Science: cache
invalidation and naming things.â€ â€” Phil Karlton</p>
</blockquote>
<h2 id="ç¼“å­˜æ¦‚è¿°">1. ç¼“å­˜æ¦‚è¿°</h2>
<h3 id="ä»€ä¹ˆæ˜¯ç¼“å­˜">1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ</h3>
<p><strong>ç¼“å­˜ï¼ˆCacheï¼‰</strong>
æ˜¯ä¸€ç§å°†æ•°æ®å­˜å‚¨åœ¨æ›´å¿«è®¿é—®å±‚çš„æŠ€æœ¯ï¼Œç”¨äºå‡å°‘æ•°æ®è®¿é—®å»¶è¿Ÿã€é™ä½åç«¯è´Ÿè½½ã€æå‡ç³»ç»Ÿååé‡ã€‚</p>
<pre><code>ç¼“å­˜ = ç”¨ç©ºé—´æ¢æ—¶é—´

CPU å¯„å­˜å™¨ (~1ns) â†’ å†…å­˜ (~100ns) â†’ ç£ç›˜ (~100Î¼s)
è®¿é—®é€Ÿåº¦å·®å¼‚å¯è¾¾ 10ä¸‡å€ï¼</code></pre>
<h3 id="å¤šçº§ç¼“å­˜æ¶æ„">1.2 å¤šçº§ç¼“å­˜æ¶æ„</h3>
<pre><code>å®¢æˆ·ç«¯ â†’ CDN â†’ ç½‘å…³å±‚ â†’ åº”ç”¨å±‚ â†’ åˆ†å¸ƒå¼ç¼“å­˜(Redis) â†’ æœ¬åœ°ç¼“å­˜ â†’ æ•°æ®åº“</code></pre>
<h3 id="net-ç¼“å­˜æŠ€æœ¯æ ˆ">1.3 .NET ç¼“å­˜æŠ€æœ¯æ ˆ</h3>
<table>
<thead>
<tr>
<th>å±‚çº§</th>
<th>æŠ€æœ¯æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æœ¬åœ°ç¼“å­˜</strong></td>
<td><code>IMemoryCache</code>ã€<code>LazyCache</code></td>
</tr>
<tr>
<td><strong>åˆ†å¸ƒå¼ç¼“å­˜</strong></td>
<td><code>IDistributedCache</code>ã€<code>StackExchange.Redis</code></td>
</tr>
<tr>
<td><strong>ç¼“å­˜æŠ½è±¡</strong></td>
<td><code>Microsoft.Extensions.Caching</code></td>
</tr>
<tr>
<td><strong>æ··åˆç¼“å­˜</strong></td>
<td><code>HybridCache</code>ï¼ˆ.NET 9ï¼‰ã€<code>FusionCache</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="å¸¸è§ç¼“å­˜é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ">2. å¸¸è§ç¼“å­˜é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
<h3 id="ç¼“å­˜ç©¿é€-cache-penetration">2.1 ç¼“å­˜ç©¿é€ (Cache
Penetration)</h3>
<p><strong>é—®é¢˜</strong>ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ°¸è¿œæ— æ³•å‘½ä¸­ï¼Œè¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚</p>
<h4 id="è§£å†³æ–¹æ¡ˆä¸€ç¼“å­˜ç©ºå¯¹è±¡">è§£å†³æ–¹æ¡ˆä¸€ï¼šç¼“å­˜ç©ºå¯¹è±¡</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserService</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IUserRepository _repository<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>User<span class="op">?&gt;</span> <span class="fu">GetUserAsync</span><span class="op">(</span><span class="dt">int</span> userId<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cacheKey <span class="op">=</span> $<span class="st">&quot;user:{userId}&quot;</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cached <span class="op">=</span> await _cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>cacheKey<span class="op">);</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>cached <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ç©ºå¯¹è±¡æ ‡è®°</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> cached <span class="op">==</span> <span class="st">&quot;NULL&quot;</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>User<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> user <span class="op">=</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>user <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>cacheKey<span class="op">,</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>user<span class="op">),</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> DistributedCacheEntryOptions <span class="op">{</span> AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">});</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ç¼“å­˜ç©ºå¯¹è±¡ï¼ŒçŸ­è¿‡æœŸæ—¶é—´</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>cacheKey<span class="op">,</span> <span class="st">&quot;NULL&quot;</span><span class="op">,</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> DistributedCacheEntryOptions <span class="op">{</span> AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span> <span class="op">});</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> user<span class="op">;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="è§£å†³æ–¹æ¡ˆäºŒå¸ƒéš†è¿‡æ»¤å™¨">è§£å†³æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨</h4>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨ BloomFilter.NetCore åŒ…</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceWithBloom</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> Filter<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> _bloomFilter<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">UserServiceWithBloom</span><span class="op">()</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé¢„åŠ è½½æ‰€æœ‰æœ‰æ•ˆID</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        _bloomFilter <span class="op">=</span> FilterBuilder<span class="op">.</span><span class="fu">Build</span><span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span><span class="dv">10000000</span><span class="op">,</span> <span class="fl">0.001</span><span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>User<span class="op">?&gt;</span> <span class="fu">GetUserAsync</span><span class="op">(</span><span class="dt">int</span> userId<span class="op">)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥ï¼šä¸å­˜åœ¨åˆ™ä¸€å®šä¸å­˜åœ¨</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>_bloomFilter<span class="op">.</span><span class="fu">Contains</span><span class="op">(</span>userId<span class="op">))</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¯èƒ½å­˜åœ¨ï¼Œç»§ç»­æŸ¥è¯¢ç¼“å­˜å’Œæ•°æ®åº“...</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await <span class="fu">GetFromCacheOrDbAsync</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ç¼“å­˜å‡»ç©¿-cache-breakdown">2.2 ç¼“å­˜å‡»ç©¿ (Cache Breakdown)</h3>
<p><strong>é—®é¢˜</strong>ï¼šçƒ­ç‚¹ Key
çªç„¶è¿‡æœŸï¼Œå¤§é‡å¹¶å‘è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚</p>
<h4 id="è§£å†³æ–¹æ¡ˆä¸€åˆ†å¸ƒå¼é”">è§£å†³æ–¹æ¡ˆä¸€ï¼šåˆ†å¸ƒå¼é”</h4>
<div class="sourceCode" id="cb5"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HotDataService</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IConnectionMultiplexer _redis<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Product<span class="op">?&gt;</span> <span class="fu">GetHotProductAsync</span><span class="op">(</span><span class="dt">int</span> productId<span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cacheKey <span class="op">=</span> $<span class="st">&quot;product:{productId}&quot;</span><span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cached <span class="op">=</span> await _cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>cacheKey<span class="op">);</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>cached <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>Product<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> lockKey <span class="op">=</span> $<span class="st">&quot;lock:{cacheKey}&quot;</span><span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> db <span class="op">=</span> _redis<span class="op">.</span><span class="fu">GetDatabase</span><span class="op">();</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å°è¯•è·å–åˆ†å¸ƒå¼é”</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>await db<span class="op">.</span><span class="fu">StringSetAsync</span><span class="op">(</span>lockKey<span class="op">,</span> <span class="st">&quot;1&quot;</span><span class="op">,</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span> When<span class="op">.</span><span class="fu">NotExists</span><span class="op">))</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">try</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                <span class="co">// åŒé‡æ£€æŸ¥</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                cached <span class="op">=</span> await _cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>cacheKey<span class="op">);</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">(</span>cached <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>Product<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> product <span class="op">=</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>productId<span class="op">);</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">(</span>product <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                    await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>cacheKey<span class="op">,</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>product<span class="op">),</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">new</span> DistributedCacheEntryOptions <span class="op">{</span> AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">});</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> product<span class="op">;</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">finally</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                await db<span class="op">.</span><span class="fu">KeyDeleteAsync</span><span class="op">(</span>lockKey<span class="op">);</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯•</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">Delay</span><span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await <span class="fu">GetHotProductAsync</span><span class="op">(</span>productId<span class="op">);</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="è§£å†³æ–¹æ¡ˆäºŒä½¿ç”¨-fusioncacheæ¨è">è§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨
FusionCacheï¼ˆæ¨èï¼‰</h4>
<div class="sourceCode" id="cb6"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// FusionCache å†…ç½®é˜²å‡»ç©¿æœºåˆ¶</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddFusionCache</span><span class="op">()</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithDefaultEntryOptions</span><span class="op">(</span><span class="kw">new</span> FusionCacheEntryOptions</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        Duration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¯ç”¨æ•…éšœå®‰å…¨æœºåˆ¶ï¼šå³ä½¿ç¼“å­˜è¿‡æœŸï¼Œä»è¿”å›æ—§æ•°æ®</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        IsFailSafeEnabled <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        FailSafeMaxDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">24</span><span class="op">),</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// åå°åˆ·æ–°</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        FactorySoftTimeout <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMilliseconds</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithDistributedCache</span><span class="op">(</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">RedisCache</span><span class="op">(</span><span class="kw">new</span> RedisCacheOptions <span class="op">{</span> Configuration <span class="op">=</span> <span class="st">&quot;localhost:6379&quot;</span> <span class="op">})</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProductService</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IFusionCache _cache<span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Product<span class="op">?&gt;</span> <span class="fu">GetProductAsync</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _cache<span class="op">.</span><span class="fu">GetOrSetAsync</span><span class="op">(</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;product:{id}&quot;</span><span class="op">,</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            async _ <span class="op">=&gt;</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>id<span class="op">),</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ç¼“å­˜é›ªå´©-cache-avalanche">2.3 ç¼“å­˜é›ªå´© (Cache Avalanche)</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¤§é‡ Key
åŒæ—¶è¿‡æœŸï¼Œæˆ–ç¼“å­˜æœåŠ¡å®•æœºï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨æ¶Œå‘æ•°æ®åº“ã€‚</p>
<h4 id="è§£å†³æ–¹æ¡ˆä¸€éšæœºè¿‡æœŸæ—¶é—´">è§£å†³æ–¹æ¡ˆä¸€ï¼šéšæœºè¿‡æœŸæ—¶é—´</h4>
<div class="sourceCode" id="cb7"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> CacheExtensions</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">readonly</span> Random _random <span class="op">=</span> <span class="kw">new</span><span class="op">();</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> async Task SetWithJitterAsync<span class="op">&lt;</span>T<span class="op">&gt;(</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span> IDistributedCache cache<span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> key<span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        T value<span class="op">,</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        TimeSpan baseDuration<span class="op">)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// åœ¨åŸºç¡€ TTL ä¸Šå¢åŠ éšæœºåç§»ï¼ˆ0-10åˆ†é’Ÿï¼‰</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> jitter <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span>_random<span class="op">.</span><span class="fu">Next</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">10</span><span class="op">));</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> options <span class="op">=</span> <span class="kw">new</span> DistributedCacheEntryOptions</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            AbsoluteExpirationRelativeToNow <span class="op">=</span> baseDuration <span class="op">+</span> jitter</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        await cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>key<span class="op">,</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>value<span class="op">),</span> options<span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="è§£å†³æ–¹æ¡ˆäºŒå¤šçº§ç¼“å­˜">è§£å†³æ–¹æ¡ˆäºŒï¼šå¤šçº§ç¼“å­˜</h4>
<div class="sourceCode" id="cb8"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MultiLevelCache</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IMemoryCache _l1Cache<span class="op">;</span>  <span class="co">// æœ¬åœ°ç¼“å­˜</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _l2Cache<span class="op">;</span>  <span class="co">// Redis</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>T<span class="op">?&gt;</span> GetAsync<span class="op">&lt;</span>T<span class="op">&gt;(</span><span class="dt">string</span> key<span class="op">)</span> where T <span class="op">:</span> <span class="kw">class</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// L1: æœ¬åœ°ç¼“å­˜</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>_l1Cache<span class="op">.</span><span class="fu">TryGetValue</span><span class="op">(</span>key<span class="op">,</span> <span class="kw">out</span> T<span class="op">?</span> value<span class="op">))</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> value<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// L2: Redis</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">try</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> cached <span class="op">=</span> await _l2Cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>cached <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>T<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                <span class="co">// å›å¡« L1ï¼ˆçŸ­è¿‡æœŸï¼‰</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                _l1Cache<span class="op">.</span><span class="fu">Set</span><span class="op">(</span>key<span class="op">,</span> value<span class="op">,</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">));</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> value<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">catch</span> <span class="op">(</span>RedisConnectionException<span class="op">)</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Redis ä¸å¯ç”¨ï¼Œé™çº§</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="è§£å†³æ–¹æ¡ˆä¸‰ç†”æ–­é™çº§polly">è§£å†³æ–¹æ¡ˆä¸‰ï¼šç†”æ–­é™çº§ï¼ˆPollyï¼‰</h4>
<div class="sourceCode" id="cb9"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨ Polly å®ç°ç†”æ–­</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddStackExchangeRedisCache</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">Configuration</span> <span class="op">=</span> <span class="st">&quot;localhost:6379&quot;</span><span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddResiliencePipeline</span><span class="op">(</span><span class="st">&quot;cache-pipeline&quot;</span><span class="op">,</span> builder <span class="op">=&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    builder</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">AddCircuitBreaker</span><span class="op">(</span><span class="kw">new</span> CircuitBreakerStrategyOptions</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            FailureRatio <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            SamplingDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            MinimumThroughput <span class="op">=</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            BreakDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">)</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">AddTimeout</span><span class="op">(</span>TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h3 id="ä¸‰å¤§é—®é¢˜å¯¹æ¯”">2.4 ä¸‰å¤§é—®é¢˜å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>åŸå› </th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç©¿é€</strong></td>
<td>æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®</td>
<td>ç¼“å­˜ç©ºå¯¹è±¡ã€å¸ƒéš†è¿‡æ»¤å™¨</td>
</tr>
<tr>
<td><strong>å‡»ç©¿</strong></td>
<td>çƒ­ç‚¹Keyè¿‡æœŸ</td>
<td>åˆ†å¸ƒå¼é”ã€FusionCache</td>
</tr>
<tr>
<td><strong>é›ªå´©</strong></td>
<td>å¤§é‡KeyåŒæ—¶è¿‡æœŸ</td>
<td>éšæœºTTLã€å¤šçº§ç¼“å­˜ã€ç†”æ–­</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">3. ç¼“å­˜æ›´æ–°ç­–ç•¥</h2>
<h3 id="cache-asideæœ€å¸¸ç”¨">3.1 Cache Asideï¼ˆæœ€å¸¸ç”¨ï¼‰</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheAsideService</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>T<span class="op">?&gt;</span> GetAsync<span class="op">&lt;</span>T<span class="op">&gt;(</span><span class="dt">string</span> key<span class="op">,</span> Func<span class="op">&lt;</span>Task<span class="op">&lt;</span>T<span class="op">?&gt;&gt;</span> factory<span class="op">)</span> where T <span class="op">:</span> <span class="kw">class</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. å…ˆæŸ¥ç¼“å­˜</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cached <span class="op">=</span> await _cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>cached <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>T<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. æŸ¥æ•°æ®åº“</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> data <span class="op">=</span> await <span class="fu">factory</span><span class="op">();</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. å›å¡«ç¼“å­˜</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>data <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>key<span class="op">,</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>data<span class="op">),</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> DistributedCacheEntryOptions <span class="op">{</span> AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">});</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> data<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task UpdateAsync<span class="op">&lt;</span>T<span class="op">&gt;(</span><span class="dt">string</span> key<span class="op">,</span> T value<span class="op">,</span> Func<span class="op">&lt;</span>Task<span class="op">&gt;</span> updateDb<span class="op">)</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. å…ˆæ›´æ–°æ•°æ®åº“</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">updateDb</span><span class="op">();</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. å†åˆ é™¤ç¼“å­˜ï¼ˆè€Œéæ›´æ–°ï¼‰</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="å»¶è¿ŸåŒåˆ ">3.2 å»¶è¿ŸåŒåˆ </h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task <span class="fu">UpdateWithDelayDeleteAsync</span><span class="op">(</span><span class="dt">string</span> key<span class="op">,</span> Product product<span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. å…ˆåˆ é™¤ç¼“å­˜</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. æ›´æ–°æ•°æ®åº“</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    await _repository<span class="op">.</span><span class="fu">UpdateAsync</span><span class="op">(</span>product<span class="op">);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. å»¶è¿Ÿå†åˆ ä¸€æ¬¡</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> Task<span class="op">.</span><span class="fu">Run</span><span class="op">(</span><span class="fu">async</span> <span class="op">()</span> <span class="op">=&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">Delay</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§">3.3 åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨ MassTransit + RabbitMQ</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProductUpdatedConsumer <span class="op">:</span> IConsumer<span class="op">&lt;</span>ProductUpdated<span class="op">&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">Consume</span><span class="op">(</span>ConsumeContext<span class="op">&lt;</span>ProductUpdated<span class="op">&gt;</span> context<span class="op">)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> key <span class="op">=</span> $<span class="st">&quot;product:{context.Message.ProductId}&quot;</span><span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">// å‘å¸ƒäº‹ä»¶</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task <span class="fu">UpdateProductAsync</span><span class="op">(</span>Product product<span class="op">)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    await _repository<span class="op">.</span><span class="fu">UpdateAsync</span><span class="op">(</span>product<span class="op">);</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    await _publishEndpoint<span class="op">.</span><span class="fu">Publish</span><span class="op">(</span><span class="kw">new</span> ProductUpdated <span class="op">{</span> ProductId <span class="op">=</span> product<span class="op">.</span><span class="fu">Id</span> <span class="op">});</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ä½¿ç”¨ç¼“å­˜æ³¨æ„äº‹é¡¹">4. ä½¿ç”¨ç¼“å­˜æ³¨æ„äº‹é¡¹</h2>
<h3 id="key-è®¾è®¡è§„èŒƒ">4.1 Key è®¾è®¡è§„èŒƒ</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> CacheKeys</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// å‘½åè§„èŒƒï¼šä¸šåŠ¡å‰ç¼€:å¯¹è±¡ç±»å‹:å”¯ä¸€æ ‡è¯†[:ç‰ˆæœ¬å·]</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">User</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">=&gt;</span> $<span class="st">&quot;user:profile:{id}&quot;</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">Product</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">=&gt;</span> $<span class="st">&quot;product:detail:{id}&quot;</span><span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">Order</span><span class="op">(</span><span class="dt">string</span> orderId<span class="op">)</span> <span class="op">=&gt;</span> $<span class="st">&quot;order:info:{orderId}&quot;</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">List</span><span class="op">(</span><span class="dt">string</span> category<span class="op">,</span> <span class="dt">int</span> page<span class="op">)</span> <span class="op">=&gt;</span> $<span class="st">&quot;list:{category}:page:{page}&quot;</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š - âœ… ä½¿ç”¨å†’å·åˆ†éš”å±‚çº§ - âœ… Key é•¿åº¦ &lt;
200 å­—èŠ‚ - âŒ é¿å…è¿‡é•¿çš„ Key - âŒ é¿å…åŒ…å«ç”¨æˆ·è¾“å…¥ï¼ˆæ³¨å…¥é£é™©ï¼‰</p>
<h3 id="å¤§-key-å¤„ç†">4.2 å¤§ Key å¤„ç†</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// æ‹†åˆ†å¤§åˆ—è¡¨</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> BigListCache</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">int</span> PageSize <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task SetLargeListAsync<span class="op">&lt;</span>T<span class="op">&gt;(</span><span class="dt">string</span> key<span class="op">,</span> List<span class="op">&lt;</span>T<span class="op">&gt;</span> items<span class="op">)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> pageCount <span class="op">=</span> <span class="op">(</span>items<span class="op">.</span><span class="fu">Count</span> <span class="op">+</span> PageSize <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> PageSize<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å­˜å‚¨å…ƒæ•°æ®</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>$<span class="st">&quot;{key}:meta&quot;</span><span class="op">,</span> </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span><span class="kw">new</span> <span class="op">{</span> Total <span class="op">=</span> items<span class="op">.</span><span class="fu">Count</span><span class="op">,</span> Pages <span class="op">=</span> pageCount <span class="op">}));</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// åˆ†é¡µå­˜å‚¨</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> pageCount<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> pageItems <span class="op">=</span> items<span class="op">.</span><span class="fu">Skip</span><span class="op">(</span>i <span class="op">*</span> PageSize<span class="op">).</span><span class="fu">Take</span><span class="op">(</span>PageSize<span class="op">).</span><span class="fu">ToList</span><span class="op">();</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span>$<span class="st">&quot;{key}:page:{i}&quot;</span><span class="op">,</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>pageItems<span class="op">));</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ç›‘æ§æŒ‡æ ‡">4.3 ç›‘æ§æŒ‡æ ‡</h3>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>å¥åº·é˜ˆå€¼</th>
<th>å‘Šè­¦é˜ˆå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å‘½ä¸­ç‡</strong></td>
<td>&gt; 90%</td>
<td>&lt; 80%</td>
</tr>
<tr>
<td><strong>P99 å»¶è¿Ÿ</strong></td>
<td>&lt; 10ms</td>
<td>&gt; 50ms</td>
</tr>
<tr>
<td><strong>å†…å­˜ä½¿ç”¨ç‡</strong></td>
<td>&lt; 80%</td>
<td>&gt; 90%</td>
</tr>
<tr>
<td><strong>è¿æ¥æ•°</strong></td>
<td>&lt; 80% max</td>
<td>&gt; 90% max</td>
</tr>
</tbody>
</table>
<h3 id="æ·˜æ±°ç­–ç•¥">4.4 æ·˜æ±°ç­–ç•¥</h3>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Redis ç­–ç•¥</th>
<th>æè¿°</th>
<th>é…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>allkeys-lru</code></td>
<td>æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆæ¨èï¼‰</td>
<td><code>maxmemory-policy allkeys-lru</code></td>
</tr>
<tr>
<td><code>allkeys-lfu</code></td>
<td>æ·˜æ±°æœ€ä¸ç»å¸¸ä½¿ç”¨</td>
<td><code>maxmemory-policy allkeys-lfu</code></td>
</tr>
<tr>
<td><code>volatile-ttl</code></td>
<td>ä¼˜å…ˆæ·˜æ±°å³å°†è¿‡æœŸ</td>
<td><code>maxmemory-policy volatile-ttl</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="net-æœ€ä½³å®è·µ">5. .NET æœ€ä½³å®è·µ</h2>
<h3 id="ä½¿ç”¨-hybridcache.net-9">5.1 ä½¿ç”¨ HybridCacheï¼ˆ.NET 9+ï¼‰</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// .NET 9 å†…ç½®çš„æ··åˆç¼“å­˜ï¼Œè‡ªåŠ¨å¤„ç†å¤šçº§ç¼“å­˜</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddHybridCache</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">DefaultEntryOptions</span> <span class="op">=</span> <span class="kw">new</span> HybridCacheEntryOptions</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        Expiration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        LocalCacheExpiration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProductService</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> HybridCache _cache<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Product<span class="op">&gt;</span> <span class="fu">GetProductAsync</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _cache<span class="op">.</span><span class="fu">GetOrCreateAsync</span><span class="op">(</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;product:{id}&quot;</span><span class="op">,</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>            async cancel <span class="op">=&gt;</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>id<span class="op">,</span> cancel<span class="op">)</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ä½¿ç”¨-fusioncacheæ¨è">5.2 ä½¿ç”¨ FusionCacheï¼ˆæ¨èï¼‰</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddFusionCache</span><span class="op">()</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithDefaultEntryOptions</span><span class="op">(</span><span class="kw">new</span> FusionCacheEntryOptions</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        Duration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        IsFailSafeEnabled <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        FailSafeMaxDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromDays</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        FactorySoftTimeout <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMilliseconds</span><span class="op">(</span><span class="dv">100</span><span class="op">),</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        AllowBackgroundDistributedCacheOperations <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithDistributedCache</span><span class="op">(</span><span class="kw">new</span> <span class="fu">RedisCache</span><span class="op">(</span><span class="kw">new</span> RedisCacheOptions </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        Configuration <span class="op">=</span> <span class="st">&quot;localhost:6379&quot;</span> </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}))</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithSerializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">FusionCacheSystemTextJsonSerializer</span><span class="op">());</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">// è‡ªåŠ¨å¤„ç†ï¼šå¤šçº§ç¼“å­˜ã€é˜²å‡»ç©¿ã€æ•…éšœå®‰å…¨ã€åå°åˆ·æ–°</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProductService</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IFusionCache _cache<span class="op">;</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Product<span class="op">?&gt;</span> <span class="fu">GetAsync</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">GetOrSetAsync</span><span class="op">(</span>$<span class="st">&quot;product:{id}&quot;</span><span class="op">,</span> </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>id<span class="op">));</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">UpdateAsync</span><span class="op">(</span>Product product<span class="op">)</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        await _repository<span class="op">.</span><span class="fu">UpdateAsync</span><span class="op">(</span>product<span class="op">);</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>$<span class="st">&quot;product:{product.Id}&quot;</span><span class="op">);</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="å®Œæ•´ç¤ºä¾‹ç”µå•†å•†å“ç¼“å­˜">5.3 å®Œæ•´ç¤ºä¾‹ï¼šç”µå•†å•†å“ç¼“å­˜</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProductCacheService</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IFusionCache _cache<span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IProductRepository _repository<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILogger<span class="op">&lt;</span>ProductCacheService<span class="op">&gt;</span> _logger<span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Product<span class="op">?&gt;</span> <span class="fu">GetProductAsync</span><span class="op">(</span><span class="dt">int</span> productId<span class="op">)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _cache<span class="op">.</span><span class="fu">GetOrSetAsync</span><span class="op">(</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            CacheKeys<span class="op">.</span><span class="fu">Product</span><span class="op">(</span>productId<span class="op">),</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            async ct <span class="op">=&gt;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Cache miss for product {Id}&quot;</span><span class="op">,</span> productId<span class="op">);</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>productId<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> FusionCacheEntryOptions</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                Duration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                JitterMaxDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span> <span class="co">// é˜²é›ªå´©</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                IsFailSafeEnabled <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>                FailSafeMaxDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">24</span><span class="op">)</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">UpdateProductAsync</span><span class="op">(</span>Product product<span class="op">)</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        await _repository<span class="op">.</span><span class="fu">UpdateAsync</span><span class="op">(</span>product<span class="op">);</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// åˆ é™¤ç¼“å­˜å¹¶å‘å¸ƒå¤±æ•ˆäº‹ä»¶</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>CacheKeys<span class="op">.</span><span class="fu">Product</span><span class="op">(</span>product<span class="op">.</span><span class="fu">Id</span><span class="op">));</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Product {Id} cache invalidated&quot;</span><span class="op">,</span> product<span class="op">.</span><span class="fu">Id</span><span class="op">);</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>List<span class="op">&lt;</span>Product<span class="op">&gt;&gt;</span> <span class="fu">GetTopProductsAsync</span><span class="op">(</span><span class="dt">int</span> count<span class="op">)</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _cache<span class="op">.</span><span class="fu">GetOrSetAsync</span><span class="op">(</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;products:top:{count}&quot;</span><span class="op">,</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> _repository<span class="op">.</span><span class="fu">GetTopAsync</span><span class="op">(</span>count<span class="op">),</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">??</span> <span class="kw">new</span> List<span class="op">&lt;</span>Product<span class="op">&gt;();</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="æ€»ç»“">6. æ€»ç»“</h2>
<h3 id="æ ¸å¿ƒè¦ç‚¹">æ ¸å¿ƒè¦ç‚¹</h3>
<table>
<colgroup>
<col style="width: 42%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr>
<th>ä¸»é¢˜</th>
<th>å…³é”®ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç¼“å­˜é—®é¢˜</strong></td>
<td>ç©¿é€â†’ç©ºå¯¹è±¡/å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå‡»ç©¿â†’åˆ†å¸ƒå¼é”/FusionCacheï¼Œé›ªå´©â†’éšæœºTTL/å¤šçº§ç¼“å­˜</td>
</tr>
<tr>
<td><strong>æ›´æ–°ç­–ç•¥</strong></td>
<td>Cache Asideï¼šå…ˆæ›´æ–° DBï¼Œå†åˆ é™¤ç¼“å­˜</td>
</tr>
<tr>
<td><strong>æ¨èæ–¹æ¡ˆ</strong></td>
<td>FusionCacheï¼ˆæˆç†Ÿï¼‰æˆ– HybridCacheï¼ˆ.NET 9+ï¼‰</td>
</tr>
<tr>
<td><strong>Key è®¾è®¡</strong></td>
<td><code>ä¸šåŠ¡:ç±»å‹:ID</code>ï¼Œé•¿åº¦é€‚ä¸­ï¼Œé¿å…å¤§ Key</td>
</tr>
<tr>
<td><strong>ç›‘æ§</strong></td>
<td>å‘½ä¸­ç‡ &gt; 90%ï¼ŒP99 &lt; 10ms</td>
</tr>
</tbody>
</table>
<h3 id="è®¾è®¡æ£€æŸ¥æ¸…å•">è®¾è®¡æ£€æŸ¥æ¸…å•</h3>
<ul class="task-list">
<li><label><input type="checkbox" />æ˜¯å¦å¤„ç†äº†ç¼“å­˜ç©¿é€ï¼Ÿ</label></li>
<li><label><input type="checkbox" />æ˜¯å¦å¤„ç†äº†ç¼“å­˜å‡»ç©¿ï¼Ÿ</label></li>
<li><label><input type="checkbox" />æ˜¯å¦å¤„ç†äº†ç¼“å­˜é›ªå´©ï¼Ÿ</label></li>
<li><label><input type="checkbox" />Key å‘½åæ˜¯å¦è§„èŒƒï¼Ÿ</label></li>
<li><label><input type="checkbox" />TTL æ˜¯å¦å¸¦éšæœºåç§»ï¼Ÿ</label></li>
<li><label><input type="checkbox" />æ˜¯å¦æœ‰é™çº§å…œåº•æ–¹æ¡ˆï¼Ÿ</label></li>
<li><label><input type="checkbox" />æ˜¯å¦æœ‰ç›‘æ§å‘Šè­¦ï¼Ÿ</label></li>
</ul>
<h3 id="å‚è€ƒèµ„æº">å‚è€ƒèµ„æº</h3>
<ul>
<li><a
href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching">Microsoft.Extensions.Caching</a></li>
<li><a
href="https://github.com/ZiggyCreatures/FusionCache">FusionCache</a></li>
<li><a
href="https://stackexchange.github.io/StackExchange.Redis/">StackExchange.Redis</a></li>
<li><a
href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/hybrid">HybridCache
in .NET 9</a></li>
</ul>

                </article>
            </div>
        </section>

        <!-- å³ä¾§çƒ­é—¨æ–‡ç«  -->
        <aside class="popular-sidebar">
            <div class="popular-header">
                <h3>çƒ­é—¨æ–‡ç« </h3>
            </div>
            <div class="popular-list" id="popular-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„çƒ­é—¨æ–‡ç« åˆ—è¡¨ -->
            </div>
        </aside>
    </main>

    <!-- JavaScript -->
    <script src="/script.js?v=2.1.2"></script>
</body>
</html>