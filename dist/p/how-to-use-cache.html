<!DOCTYPE html>
<html lang="zh-CN" class="page-article">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    <meta name="keywords" content="æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    <meta name="author" content="Ken Wang">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <meta property="og:title" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“">
    <meta property="og:description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <meta property="twitter:title" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“">
    <meta property="twitter:description" content="ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6366f1">
    
    <title>ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - Kençš„çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="/style.css?v=2.1.2">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%236366f1%22>ğŸ“š</text></svg>">
    <link rel="canonical" href="https://kenwang007.github.io/dist/p/how-to-use-cache.html">
    <link rel="manifest" href="/manifest.json">
    
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Kençš„çŸ¥è¯†åº“ RSS Feed" href="/rss.xml">
    
    <!-- Breadcrumb Navigation -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "é¦–é¡µ",
          "item": "https://kenwang007.github.io/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
          "item": "https://kenwang007.github.io/dist/p/how-to-use-cache.html"
        }
      ]
    }
    </script>
    
    <!-- Article Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
      "description": "ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ - å…³é”®è¯: æ¶æ„, è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ",
      "author": {
        "@type": "Person",
        "name": "Ken Wang"
      },
      "datePublished": "2026-01-26T17:24:16.214865",
      "dateModified": "2026-01-26T17:24:16.214865",
      "inLanguage": "zh-CN"
    }
    </script>
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="stars3"></div>

    <!-- é¡¶éƒ¨å›ºå®šå¯¼èˆª -->
    <header class="top-nav">
        <div class="nav-container">
            <div class="logo">
                <a href="/index.html">
                    <span class="logo-text">ğŸ“š Kençš„çŸ¥è¯†åº“</span>
                </a>
            </div>
            <nav class="main-nav">
                <ul id="nav-menu" class="nav-menu">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªèœå•é¡¹ -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- å·¦ä¾§å›ºå®šå…³é”®è¯ç´¢å¼• -->
        <aside class="keyword-sidebar">
            <div class="keyword-header">
                <h3>å…³é”®è¯ç´¢å¼•</h3>
            </div>
            <div class="keyword-list" id="keyword-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å…³é”®è¯ -->
            </div>
        </aside>

        <!-- ä¸­é—´ä¸»å†…å®¹ -->
        <section class="content-area">
            <div class="content-wrapper">
                <article class="markdown-content">
                    <h1>ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ</h1><pre>---
slug: how-to-use-cache
title: ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ
---

# ğŸ’¾ è½¯ä»¶æ¶æ„ä¸­çš„ç¼“å­˜è®¾è®¡å…¨è§£æ

> "There are only two hard things in Computer Science: cache invalidation and naming things." â€” Phil Karlton

## 1. ç¼“å­˜æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ

**ç¼“å­˜ï¼ˆCacheï¼‰** æ˜¯ä¸€ç§å°†æ•°æ®å­˜å‚¨åœ¨æ›´å¿«è®¿é—®å±‚çš„æŠ€æœ¯ï¼Œç”¨äºå‡å°‘æ•°æ®è®¿é—®å»¶è¿Ÿã€é™ä½åç«¯è´Ÿè½½ã€æå‡ç³»ç»Ÿååé‡ã€‚

```
ç¼“å­˜ = ç”¨ç©ºé—´æ¢æ—¶é—´

CPU å¯„å­˜å™¨ (~1ns) â†’ å†…å­˜ (~100ns) â†’ ç£ç›˜ (~100Î¼s)
è®¿é—®é€Ÿåº¦å·®å¼‚å¯è¾¾ 10ä¸‡å€ï¼
```

### 1.2 å¤šçº§ç¼“å­˜æ¶æ„

```
å®¢æˆ·ç«¯ â†’ CDN â†’ ç½‘å…³å±‚ â†’ åº”ç”¨å±‚ â†’ åˆ†å¸ƒå¼ç¼“å­˜(Redis) â†’ æœ¬åœ°ç¼“å­˜ â†’ æ•°æ®åº“
```

### 1.3 .NET ç¼“å­˜æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯æ–¹æ¡ˆ |
|------|----------|
| **æœ¬åœ°ç¼“å­˜** | `IMemoryCache`ã€`LazyCache` |
| **åˆ†å¸ƒå¼ç¼“å­˜** | `IDistributedCache`ã€`StackExchange.Redis` |
| **ç¼“å­˜æŠ½è±¡** | `Microsoft.Extensions.Caching` |
| **æ··åˆç¼“å­˜** | `HybridCache`ï¼ˆ.NET 9ï¼‰ã€`FusionCache` |

---

## 2. å¸¸è§ç¼“å­˜é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 2.1 ç¼“å­˜ç©¿é€ (Cache Penetration)

**é—®é¢˜**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ°¸è¿œæ— æ³•å‘½ä¸­ï¼Œè¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚

#### è§£å†³æ–¹æ¡ˆä¸€ï¼šç¼“å­˜ç©ºå¯¹è±¡

```csharp
public class UserService
{
    private readonly IDistributedCache _cache;
    private readonly IUserRepository _repository;
    
    public async Task&lt;User?> GetUserAsync(int userId)
    {
        var cacheKey = $"user:{userId}";
        var cached = await _cache.GetStringAsync(cacheKey);
        
        if (cached != null)
        {
            // ç©ºå¯¹è±¡æ ‡è®°
            return cached == "NULL" ? null : JsonSerializer.Deserialize&lt;User>(cached);
        }
        
        var user = await _repository.GetByIdAsync(userId);
        
        if (user != null)
        {
            await _cache.SetStringAsync(cacheKey, JsonSerializer.Serialize(user),
                new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(1) });
        }
        else
        {
            // ç¼“å­˜ç©ºå¯¹è±¡ï¼ŒçŸ­è¿‡æœŸæ—¶é—´
            await _cache.SetStringAsync(cacheKey, "NULL",
                new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5) });
        }
        
        return user;
    }
}
```

#### è§£å†³æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨

```csharp
// ä½¿ç”¨ BloomFilter.NetCore åŒ…
public class UserServiceWithBloom
{
    private readonly Filter&lt;int> _bloomFilter;
    private readonly IDistributedCache _cache;
    
    public UserServiceWithBloom()
    {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé¢„åŠ è½½æ‰€æœ‰æœ‰æ•ˆID
        _bloomFilter = FilterBuilder.Build&lt;int>(10000000, 0.001);
    }
    
    public async Task&lt;User?> GetUserAsync(int userId)
    {
        // å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥ï¼šä¸å­˜åœ¨åˆ™ä¸€å®šä¸å­˜åœ¨
        if (!_bloomFilter.Contains(userId))
            return null;
        
        // å¯èƒ½å­˜åœ¨ï¼Œç»§ç»­æŸ¥è¯¢ç¼“å­˜å’Œæ•°æ®åº“...
        return await GetFromCacheOrDbAsync(userId);
    }
}
```

### 2.2 ç¼“å­˜å‡»ç©¿ (Cache Breakdown)

**é—®é¢˜**ï¼šçƒ­ç‚¹ Key çªç„¶è¿‡æœŸï¼Œå¤§é‡å¹¶å‘è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚

#### è§£å†³æ–¹æ¡ˆä¸€ï¼šåˆ†å¸ƒå¼é”

```csharp
public class HotDataService
{
    private readonly IDistributedCache _cache;
    private readonly IConnectionMultiplexer _redis;
    
    public async Task&lt;Product?> GetHotProductAsync(int productId)
    {
        var cacheKey = $"product:{productId}";
        var cached = await _cache.GetStringAsync(cacheKey);
        
        if (cached != null)
            return JsonSerializer.Deserialize&lt;Product>(cached);
        
        var lockKey = $"lock:{cacheKey}";
        var db = _redis.GetDatabase();
        
        // å°è¯•è·å–åˆ†å¸ƒå¼é”
        if (await db.StringSetAsync(lockKey, "1", TimeSpan.FromSeconds(10), When.NotExists))
        {
            try
            {
                // åŒé‡æ£€æŸ¥
                cached = await _cache.GetStringAsync(cacheKey);
                if (cached != null)
                    return JsonSerializer.Deserialize&lt;Product>(cached);
                
                var product = await _repository.GetByIdAsync(productId);
                if (product != null)
                {
                    await _cache.SetStringAsync(cacheKey, JsonSerializer.Serialize(product),
                        new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(1) });
                }
                return product;
            }
            finally
            {
                await db.KeyDeleteAsync(lockKey);
            }
        }
        
        // æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯•
        await Task.Delay(100);
        return await GetHotProductAsync(productId);
    }
}
```

#### è§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ FusionCacheï¼ˆæ¨èï¼‰

```csharp
// FusionCache å†…ç½®é˜²å‡»ç©¿æœºåˆ¶
builder.Services.AddFusionCache()
    .WithDefaultEntryOptions(new FusionCacheEntryOptions
    {
        Duration = TimeSpan.FromHours(1),
        // å¯ç”¨æ•…éšœå®‰å…¨æœºåˆ¶ï¼šå³ä½¿ç¼“å­˜è¿‡æœŸï¼Œä»è¿”å›æ—§æ•°æ®
        IsFailSafeEnabled = true,
        FailSafeMaxDuration = TimeSpan.FromHours(24),
        // åå°åˆ·æ–°
        FactorySoftTimeout = TimeSpan.FromMilliseconds(100)
    })
    .WithDistributedCache(
        new RedisCache(new RedisCacheOptions { Configuration = "localhost:6379" })
    );

// ä½¿ç”¨
public class ProductService
{
    private readonly IFusionCache _cache;
    
    public async Task&lt;Product?> GetProductAsync(int id)
    {
        return await _cache.GetOrSetAsync(
            $"product:{id}",
            async _ => await _repository.GetByIdAsync(id),
            TimeSpan.FromHours(1)
        );
    }
}
```

### 2.3 ç¼“å­˜é›ªå´© (Cache Avalanche)

**é—®é¢˜**ï¼šå¤§é‡ Key åŒæ—¶è¿‡æœŸï¼Œæˆ–ç¼“å­˜æœåŠ¡å®•æœºï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨æ¶Œå‘æ•°æ®åº“ã€‚

#### è§£å†³æ–¹æ¡ˆä¸€ï¼šéšæœºè¿‡æœŸæ—¶é—´

```csharp
public static class CacheExtensions
{
    private static readonly Random _random = new();
    
    public static async Task SetWithJitterAsync&lt;T>(
        this IDistributedCache cache,
        string key,
        T value,
        TimeSpan baseDuration)
    {
        // åœ¨åŸºç¡€ TTL ä¸Šå¢åŠ éšæœºåç§»ï¼ˆ0-10åˆ†é’Ÿï¼‰
        var jitter = TimeSpan.FromMinutes(_random.Next(0, 10));
        var options = new DistributedCacheEntryOptions
        {
            AbsoluteExpirationRelativeToNow = baseDuration + jitter
        };
        
        await cache.SetStringAsync(key, JsonSerializer.Serialize(value), options);
    }
}
```

#### è§£å†³æ–¹æ¡ˆäºŒï¼šå¤šçº§ç¼“å­˜

```csharp
public class MultiLevelCache
{
    private readonly IMemoryCache _l1Cache;  // æœ¬åœ°ç¼“å­˜
    private readonly IDistributedCache _l2Cache;  // Redis
    
    public async Task&lt;T?> GetAsync&lt;T>(string key) where T : class
    {
        // L1: æœ¬åœ°ç¼“å­˜
        if (_l1Cache.TryGetValue(key, out T? value))
            return value;
        
        // L2: Redis
        try
        {
            var cached = await _l2Cache.GetStringAsync(key);
            if (cached != null)
            {
                value = JsonSerializer.Deserialize&lt;T>(cached);
                // å›å¡« L1ï¼ˆçŸ­è¿‡æœŸï¼‰
                _l1Cache.Set(key, value, TimeSpan.FromSeconds(30));
                return value;
            }
        }
        catch (RedisConnectionException)
        {
            // Redis ä¸å¯ç”¨ï¼Œé™çº§
        }
        
        return null;
    }
}
```

#### è§£å†³æ–¹æ¡ˆä¸‰ï¼šç†”æ–­é™çº§ï¼ˆPollyï¼‰

```csharp
// ä½¿ç”¨ Polly å®ç°ç†”æ–­
builder.Services.AddStackExchangeRedisCache(options =>
{
    options.Configuration = "localhost:6379";
});

builder.Services.AddResiliencePipeline("cache-pipeline", builder =>
{
    builder
        .AddCircuitBreaker(new CircuitBreakerStrategyOptions
        {
            FailureRatio = 0.5,
            SamplingDuration = TimeSpan.FromSeconds(10),
            MinimumThroughput = 10,
            BreakDuration = TimeSpan.FromSeconds(30)
        })
        .AddTimeout(TimeSpan.FromSeconds(1));
});
```

### 2.4 ä¸‰å¤§é—®é¢˜å¯¹æ¯”

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **ç©¿é€** | æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® | ç¼“å­˜ç©ºå¯¹è±¡ã€å¸ƒéš†è¿‡æ»¤å™¨ |
| **å‡»ç©¿** | çƒ­ç‚¹Keyè¿‡æœŸ | åˆ†å¸ƒå¼é”ã€FusionCache |
| **é›ªå´©** | å¤§é‡KeyåŒæ—¶è¿‡æœŸ | éšæœºTTLã€å¤šçº§ç¼“å­˜ã€ç†”æ–­ |

---

## 3. ç¼“å­˜æ›´æ–°ç­–ç•¥

### 3.1 Cache Asideï¼ˆæœ€å¸¸ç”¨ï¼‰

```csharp
public class CacheAsideService
{
    public async Task&lt;T?> GetAsync&lt;T>(string key, Func&lt;Task&lt;T?>> factory) where T : class
    {
        // 1. å…ˆæŸ¥ç¼“å­˜
        var cached = await _cache.GetStringAsync(key);
        if (cached != null)
            return JsonSerializer.Deserialize&lt;T>(cached);
        
        // 2. æŸ¥æ•°æ®åº“
        var data = await factory();
        
        // 3. å›å¡«ç¼“å­˜
        if (data != null)
        {
            await _cache.SetStringAsync(key, JsonSerializer.Serialize(data),
                new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(1) });
        }
        
        return data;
    }
    
    public async Task UpdateAsync&lt;T>(string key, T value, Func&lt;Task> updateDb)
    {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        await updateDb();
        
        // 2. å†åˆ é™¤ç¼“å­˜ï¼ˆè€Œéæ›´æ–°ï¼‰
        await _cache.RemoveAsync(key);
    }
}
```

### 3.2 å»¶è¿ŸåŒåˆ 

```csharp
public async Task UpdateWithDelayDeleteAsync(string key, Product product)
{
    // 1. å…ˆåˆ é™¤ç¼“å­˜
    await _cache.RemoveAsync(key);
    
    // 2. æ›´æ–°æ•°æ®åº“
    await _repository.UpdateAsync(product);
    
    // 3. å»¶è¿Ÿå†åˆ ä¸€æ¬¡
    _ = Task.Run(async () =>
    {
        await Task.Delay(500);
        await _cache.RemoveAsync(key);
    });
}
```

### 3.3 åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§

```csharp
// ä½¿ç”¨ MassTransit + RabbitMQ
public class ProductUpdatedConsumer : IConsumer&lt;ProductUpdated>
{
    private readonly IDistributedCache _cache;
    
    public async Task Consume(ConsumeContext&lt;ProductUpdated> context)
    {
        var key = $"product:{context.Message.ProductId}";
        await _cache.RemoveAsync(key);
    }
}

// å‘å¸ƒäº‹ä»¶
public async Task UpdateProductAsync(Product product)
{
    await _repository.UpdateAsync(product);
    await _publishEndpoint.Publish(new ProductUpdated { ProductId = product.Id });
}
```

---

## 4. ä½¿ç”¨ç¼“å­˜æ³¨æ„äº‹é¡¹

### 4.1 Key è®¾è®¡è§„èŒƒ

```csharp
public static class CacheKeys
{
    // å‘½åè§„èŒƒï¼šä¸šåŠ¡å‰ç¼€:å¯¹è±¡ç±»å‹:å”¯ä¸€æ ‡è¯†[:ç‰ˆæœ¬å·]
    public static string User(int id) => $"user:profile:{id}";
    public static string Product(int id) => $"product:detail:{id}";
    public static string Order(string orderId) => $"order:info:{orderId}";
    public static string List(string category, int page) => $"list:{category}:page:{page}";
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âœ… ä½¿ç”¨å†’å·åˆ†éš”å±‚çº§
- âœ… Key é•¿åº¦ &lt; 200 å­—èŠ‚
- âŒ é¿å…è¿‡é•¿çš„ Key
- âŒ é¿å…åŒ…å«ç”¨æˆ·è¾“å…¥ï¼ˆæ³¨å…¥é£é™©ï¼‰

### 4.2 å¤§ Key å¤„ç†

```csharp
// æ‹†åˆ†å¤§åˆ—è¡¨
public class BigListCache
{
    private const int PageSize = 100;
    
    public async Task SetLargeListAsync&lt;T>(string key, List&lt;T> items)
    {
        var pageCount = (items.Count + PageSize - 1) / PageSize;
        
        // å­˜å‚¨å…ƒæ•°æ®
        await _cache.SetStringAsync($"{key}:meta", 
            JsonSerializer.Serialize(new { Total = items.Count, Pages = pageCount }));
        
        // åˆ†é¡µå­˜å‚¨
        for (int i = 0; i &lt; pageCount; i++)
        {
            var pageItems = items.Skip(i * PageSize).Take(PageSize).ToList();
            await _cache.SetStringAsync($"{key}:page:{i}", JsonSerializer.Serialize(pageItems));
        }
    }
}
```

### 4.3 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | å¥åº·é˜ˆå€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|----------|----------|
| **å‘½ä¸­ç‡** | > 90% | &lt; 80% |
| **P99 å»¶è¿Ÿ** | &lt; 10ms | > 50ms |
| **å†…å­˜ä½¿ç”¨ç‡** | &lt; 80% | > 90% |
| **è¿æ¥æ•°** | &lt; 80% max | > 90% max |

### 4.4 æ·˜æ±°ç­–ç•¥

| Redis ç­–ç•¥ | æè¿° | é…ç½® |
|------------|------|------|
| `allkeys-lru` | æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆæ¨èï¼‰ | `maxmemory-policy allkeys-lru` |
| `allkeys-lfu` | æ·˜æ±°æœ€ä¸ç»å¸¸ä½¿ç”¨ | `maxmemory-policy allkeys-lfu` |
| `volatile-ttl` | ä¼˜å…ˆæ·˜æ±°å³å°†è¿‡æœŸ | `maxmemory-policy volatile-ttl` |

---

## 5. .NET æœ€ä½³å®è·µ

### 5.1 ä½¿ç”¨ HybridCacheï¼ˆ.NET 9+ï¼‰

```csharp
// .NET 9 å†…ç½®çš„æ··åˆç¼“å­˜ï¼Œè‡ªåŠ¨å¤„ç†å¤šçº§ç¼“å­˜
builder.Services.AddHybridCache(options =>
{
    options.DefaultEntryOptions = new HybridCacheEntryOptions
    {
        Expiration = TimeSpan.FromHours(1),
        LocalCacheExpiration = TimeSpan.FromMinutes(5)
    };
});

public class ProductService
{
    private readonly HybridCache _cache;
    
    public async Task&lt;Product> GetProductAsync(int id)
    {
        return await _cache.GetOrCreateAsync(
            $"product:{id}",
            async cancel => await _repository.GetByIdAsync(id, cancel)
        );
    }
}
```

### 5.2 ä½¿ç”¨ FusionCacheï¼ˆæ¨èï¼‰

```csharp
builder.Services.AddFusionCache()
    .WithDefaultEntryOptions(new FusionCacheEntryOptions
    {
        Duration = TimeSpan.FromHours(1),
        IsFailSafeEnabled = true,
        FailSafeMaxDuration = TimeSpan.FromDays(1),
        FactorySoftTimeout = TimeSpan.FromMilliseconds(100),
        AllowBackgroundDistributedCacheOperations = true
    })
    .WithDistributedCache(new RedisCache(new RedisCacheOptions 
    { 
        Configuration = "localhost:6379" 
    }))
    .WithSerializer(new FusionCacheSystemTextJsonSerializer());

// è‡ªåŠ¨å¤„ç†ï¼šå¤šçº§ç¼“å­˜ã€é˜²å‡»ç©¿ã€æ•…éšœå®‰å…¨ã€åå°åˆ·æ–°
public class ProductService
{
    private readonly IFusionCache _cache;
    
    public async Task&lt;Product?> GetAsync(int id) =>
        await _cache.GetOrSetAsync($"product:{id}", 
            _ => _repository.GetByIdAsync(id));
    
    public async Task UpdateAsync(Product product)
    {
        await _repository.UpdateAsync(product);
        await _cache.RemoveAsync($"product:{product.Id}");
    }
}
```

### 5.3 å®Œæ•´ç¤ºä¾‹ï¼šç”µå•†å•†å“ç¼“å­˜

```csharp
public class ProductCacheService
{
    private readonly IFusionCache _cache;
    private readonly IProductRepository _repository;
    private readonly ILogger&lt;ProductCacheService> _logger;
    
    public async Task&lt;Product?> GetProductAsync(int productId)
    {
        return await _cache.GetOrSetAsync(
            CacheKeys.Product(productId),
            async ct =>
            {
                _logger.LogInformation("Cache miss for product {Id}", productId);
                return await _repository.GetByIdAsync(productId, ct);
            },
            new FusionCacheEntryOptions
            {
                Duration = TimeSpan.FromHours(1),
                JitterMaxDuration = TimeSpan.FromMinutes(10), // é˜²é›ªå´©
                IsFailSafeEnabled = true,
                FailSafeMaxDuration = TimeSpan.FromHours(24)
            }
        );
    }
    
    public async Task UpdateProductAsync(Product product)
    {
        await _repository.UpdateAsync(product);
        
        // åˆ é™¤ç¼“å­˜å¹¶å‘å¸ƒå¤±æ•ˆäº‹ä»¶
        await _cache.RemoveAsync(CacheKeys.Product(product.Id));
        
        _logger.LogInformation("Product {Id} cache invalidated", product.Id);
    }
    
    public async Task&lt;List&lt;Product>> GetTopProductsAsync(int count)
    {
        return await _cache.GetOrSetAsync(
            $"products:top:{count}",
            _ => _repository.GetTopAsync(count),
            TimeSpan.FromMinutes(10)
        ) ?? new List&lt;Product>();
    }
}
```

---

## 6. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

| ä¸»é¢˜ | å…³é”®ç‚¹ |
|------|--------|
| **ç¼“å­˜é—®é¢˜** | ç©¿é€â†’ç©ºå¯¹è±¡/å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå‡»ç©¿â†’åˆ†å¸ƒå¼é”/FusionCacheï¼Œé›ªå´©â†’éšæœºTTL/å¤šçº§ç¼“å­˜ |
| **æ›´æ–°ç­–ç•¥** | Cache Asideï¼šå…ˆæ›´æ–° DBï¼Œå†åˆ é™¤ç¼“å­˜ |
| **æ¨èæ–¹æ¡ˆ** | FusionCacheï¼ˆæˆç†Ÿï¼‰æˆ– HybridCacheï¼ˆ.NET 9+ï¼‰ |
| **Key è®¾è®¡** | `ä¸šåŠ¡:ç±»å‹:ID`ï¼Œé•¿åº¦é€‚ä¸­ï¼Œé¿å…å¤§ Key |
| **ç›‘æ§** | å‘½ä¸­ç‡ > 90%ï¼ŒP99 &lt; 10ms |

### è®¾è®¡æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜ç©¿é€ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜å‡»ç©¿ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜é›ªå´©ï¼Ÿ
- [ ] Key å‘½åæ˜¯å¦è§„èŒƒï¼Ÿ
- [ ] TTL æ˜¯å¦å¸¦éšæœºåç§»ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é™çº§å…œåº•æ–¹æ¡ˆï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç›‘æ§å‘Šè­¦ï¼Ÿ

### å‚è€ƒèµ„æº

- [Microsoft.Extensions.Caching](https://learn.microsoft.com/en-us/aspnet/core/performance/caching)
- [FusionCache](https://github.com/ZiggyCreatures/FusionCache)
- [StackExchange.Redis](https://stackexchange.github.io/StackExchange.Redis/)
- [HybridCache in .NET 9](https://learn.microsoft.com/en-us/aspnet/core/performance/caching/hybrid)
</pre>
                </article>
            </div>
        </section>

        <!-- å³ä¾§çƒ­é—¨æ–‡ç«  -->
        <aside class="popular-sidebar">
            <div class="popular-header">
                <h3>çƒ­é—¨æ–‡ç« </h3>
            </div>
            <div class="popular-list" id="popular-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„çƒ­é—¨æ–‡ç« åˆ—è¡¨ -->
            </div>
        </aside>
    </main>

    <!-- JavaScript -->
    <script src="/script.js?v=2.1.2"></script>
</body>
</html>