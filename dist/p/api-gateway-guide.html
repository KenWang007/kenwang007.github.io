<!DOCTYPE html>
<html lang="zh-CN" class="page-article">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - å…³é”®è¯: API, ç½‘å…³è®¾è®¡æŒ‡å—">
    <meta name="keywords" content="API, ç½‘å…³è®¾è®¡æŒ‡å—">
    <meta name="author" content="Ken Wang">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://kenwang007.github.io/dist/p/api-gateway-guide.html">
    <meta property="og:title" content="ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - Kençš„çŸ¥è¯†åº“">
    <meta property="og:description" content="ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - å…³é”®è¯: API, ç½‘å…³è®¾è®¡æŒ‡å—">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://kenwang007.github.io/dist/p/api-gateway-guide.html">
    <meta property="twitter:title" content="ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - Kençš„çŸ¥è¯†åº“">
    <meta property="twitter:description" content="ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - å…³é”®è¯: API, ç½‘å…³è®¾è®¡æŒ‡å—">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6366f1">
    
    <title>ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - Kençš„çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="/style.css?v=2.1.2">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%236366f1%22>ğŸ“š</text></svg>">
    <link rel="canonical" href="https://kenwang007.github.io/dist/p/api-gateway-guide.html">
    <link rel="manifest" href="/manifest.json">
    
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Kençš„çŸ¥è¯†åº“ RSS Feed" href="/rss.xml">
    
    <!-- Breadcrumb Navigation -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "é¦–é¡µ",
          "item": "https://kenwang007.github.io/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å—",
          "item": "https://kenwang007.github.io/dist/p/api-gateway-guide.html"
        }
      ]
    }
    </script>
    
    <!-- Article Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": "ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å—",
      "description": "ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å— - å…³é”®è¯: API, ç½‘å…³è®¾è®¡æŒ‡å—",
      "author": {
        "@type": "Person",
        "name": "Ken Wang"
      },
      "datePublished": "2026-01-29T20:26:18.620897",
      "dateModified": "2026-01-29T20:26:18.620897",
      "inLanguage": "zh-CN"
    }
    </script>
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="stars3"></div>

    <!-- é¡¶éƒ¨å›ºå®šå¯¼èˆª -->
    <header class="top-nav">
        <div class="nav-container">
            <div class="logo">
                <a href="/index.html">
                    <span class="logo-text">ğŸ“š Kençš„çŸ¥è¯†åº“</span>
                </a>
            </div>
            <nav class="main-nav">
                <ul id="nav-menu" class="nav-menu">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªèœå•é¡¹ -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- å·¦ä¾§å›ºå®šå…³é”®è¯ç´¢å¼• -->
        <aside class="keyword-sidebar">
            <div class="keyword-header">
                <h3>å…³é”®è¯ç´¢å¼•</h3>
            </div>
            <div class="keyword-list" id="keyword-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å…³é”®è¯ -->
            </div>
        </aside>

        <!-- ä¸­é—´ä¸»å†…å®¹ -->
        <section class="content-area">
            <div class="content-wrapper">
                <article class="markdown-content">
                    
<h1 id="api-ç½‘å…³è®¾è®¡æŒ‡å—">ğŸšª API ç½‘å…³è®¾è®¡æŒ‡å—</h1>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³">1. ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³ï¼Ÿ</h2>
<h3 id="æ²¡æœ‰ç½‘å…³çš„é—®é¢˜">1.1 æ²¡æœ‰ç½‘å…³çš„é—®é¢˜</h3>
<pre><code>ä¼ ç»Ÿæ¶æ„ï¼ˆæ— ç½‘å…³ï¼‰ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Client  â”‚â”€â”€â”€â”€â†’â”‚  Service A  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  Service B  â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  Service C  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
â€¢ å®¢æˆ·ç«¯éœ€è¦çŸ¥é“æ‰€æœ‰æœåŠ¡åœ°å€
â€¢ æ¯ä¸ªæœåŠ¡éƒ½è¦å®ç°è®¤è¯ã€é™æµã€æ—¥å¿—
â€¢ è·¨åŸŸã€åè®®è½¬æ¢ç­‰é‡å¤å¤„ç†
â€¢ æœåŠ¡å˜æ›´å®¢æˆ·ç«¯éœ€è¦åŒæ­¥ä¿®æ”¹
â€¢ å®‰å…¨è¾¹ç•Œæ¨¡ç³Šï¼Œæ”»å‡»é¢å¤§</code></pre>
<h3 id="ç½‘å…³è§£å†³çš„æ ¸å¿ƒé—®é¢˜">1.2 ç½‘å…³è§£å†³çš„æ ¸å¿ƒé—®é¢˜</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ç½‘å…³è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç»Ÿä¸€å…¥å£</strong></td>
<td>å•ä¸€è®¿é—®ç‚¹ï¼Œå±è”½åç«¯å¤æ‚æ€§</td>
</tr>
<tr>
<td><strong>å®‰å…¨è¾¹ç•Œ</strong></td>
<td>é›†ä¸­è®¤è¯æˆæƒï¼Œå‡å°‘æ”»å‡»é¢</td>
</tr>
<tr>
<td><strong>æµé‡ç®¡æ§</strong></td>
<td>é™æµã€ç†”æ–­ã€è´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td><strong>åè®®è½¬æ¢</strong></td>
<td>HTTP/gRPC/WebSocket äº’è½¬</td>
</tr>
<tr>
<td><strong>è¯·æ±‚èšåˆ</strong></td>
<td>BFF æ¨¡å¼ï¼Œå‡å°‘å®¢æˆ·ç«¯è¯·æ±‚æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>ç›‘æ§å®¡è®¡</strong></td>
<td>ç»Ÿä¸€æ—¥å¿—ã€é“¾è·¯è¿½è¸ªã€æŒ‡æ ‡é‡‡é›†</td>
</tr>
<tr>
<td><strong>ç°åº¦å‘å¸ƒ</strong></td>
<td>æŒ‰è§„åˆ™è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬</td>
</tr>
</tbody>
</table>
<h3 id="ç½‘å…³æ¶æ„">1.3 ç½‘å…³æ¶æ„</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API Gateway                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  è®¤è¯   â”‚ â”‚  é™æµ   â”‚ â”‚  è·¯ç”±   â”‚ â”‚  ç›‘æ§   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ç¼“å­˜   â”‚ â”‚  ç†”æ–­   â”‚ â”‚  è½¬æ¢   â”‚ â”‚  æ—¥å¿—   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service A  â”‚ â”‚  Service B  â”‚ â”‚  Service C  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<hr />
<h2 id="ç½‘å…³åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨">2. ç½‘å…³åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨</h2>
<h3 id="æ ¸å¿ƒåŠŸèƒ½">2.1 æ ¸å¿ƒåŠŸèƒ½</h3>
<h4 id="è·¯ç”±ä¸è´Ÿè½½å‡è¡¡">è·¯ç”±ä¸è´Ÿè½½å‡è¡¡</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// YARP è·¯ç”±é…ç½®ç¤ºä¾‹</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;ReverseProxy&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Routes&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;orders-route&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ClusterId&quot;</span><span class="op">:</span> <span class="st">&quot;orders-cluster&quot;</span><span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Match&quot;</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;Path&quot;</span><span class="op">:</span> <span class="st">&quot;/api/orders/{**catch-all}&quot;</span> <span class="op">}</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">},</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;users-route&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ClusterId&quot;</span><span class="op">:</span> <span class="st">&quot;users-cluster&quot;</span><span class="op">,</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Match&quot;</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;Path&quot;</span><span class="op">:</span> <span class="st">&quot;/api/users/{**catch-all}&quot;</span> <span class="op">}</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Clusters&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;orders-cluster&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;LoadBalancingPolicy&quot;</span><span class="op">:</span> <span class="st">&quot;RoundRobin&quot;</span><span class="op">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Destinations&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;d1&quot;</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;Address&quot;</span><span class="op">:</span> <span class="st">&quot;http://orders-service-1:5000&quot;</span> <span class="op">},</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;d2&quot;</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;Address&quot;</span><span class="op">:</span> <span class="st">&quot;http://orders-service-2:5000&quot;</span> <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="è®¤è¯ä¸æˆæƒ">è®¤è¯ä¸æˆæƒ</h4>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// JWT è®¤è¯ä¸­é—´ä»¶</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddAuthentication</span><span class="op">(</span>JwtBearerDefaults<span class="op">.</span><span class="fu">AuthenticationScheme</span><span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddJwtBearer</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        options<span class="op">.</span><span class="fu">Authority</span> <span class="op">=</span> <span class="st">&quot;https://identity-server&quot;</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">.</span><span class="fu">Audience</span> <span class="op">=</span> <span class="st">&quot;api-gateway&quot;</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ç½‘å…³ç»Ÿä¸€éªŒè¯ï¼Œä¸‹æ¸¸æœåŠ¡ä¿¡ä»»ç½‘å…³</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">UseAuthentication</span><span class="op">();</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">UseAuthorization</span><span class="op">();</span></span></code></pre></div>
<h4 id="é™æµä¸ç†”æ–­">é™æµä¸ç†”æ–­</h4>
<div class="sourceCode" id="cb5"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨ Polly å®ç°ç†”æ–­</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddReverseProxy</span><span class="op">()</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">LoadFromConfig</span><span class="op">(</span>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">GetSection</span><span class="op">(</span><span class="st">&quot;ReverseProxy&quot;</span><span class="op">))</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddTransforms</span><span class="op">(</span>context <span class="op">=&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">AddRequestTransform</span><span class="op">(</span>async transformContext <span class="op">=&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">// æ·»åŠ é™æµé€»è¾‘</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            await _rateLimiter<span class="op">.</span><span class="fu">WaitAsync</span><span class="op">(</span>transformContext<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">RequestAborted</span><span class="op">);</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span></code></pre></div>
<h4 id="è¯·æ±‚èšåˆbff-æ¨¡å¼">è¯·æ±‚èšåˆï¼ˆBFF æ¨¡å¼ï¼‰</h4>
<div class="sourceCode" id="cb6"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// GraphQL èšåˆå¤šä¸ªæœåŠ¡</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Query</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>OrderWithUser<span class="op">&gt;</span> <span class="fu">GetOrderDetail</span><span class="op">(</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>Service<span class="op">]</span> IOrderService orderService<span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>Service<span class="op">]</span> IUserService userService<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> orderId<span class="op">)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> order <span class="op">=</span> await orderService<span class="op">.</span><span class="fu">GetOrderAsync</span><span class="op">(</span>orderId<span class="op">);</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> user <span class="op">=</span> await userService<span class="op">.</span><span class="fu">GetUserAsync</span><span class="op">(</span>order<span class="op">.</span><span class="fu">UserId</span><span class="op">);</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">new</span> OrderWithUser <span class="op">{</span> Order <span class="op">=</span> order<span class="op">,</span> User <span class="op">=</span> user <span class="op">};</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="å¸¸è§æ¶æ„æ¨¡å¼">2.2 å¸¸è§æ¶æ„æ¨¡å¼</h3>
<h4 id="å•ä¸€ç½‘å…³">å•ä¸€ç½‘å…³</h4>
<pre><code>é€‚ç”¨ï¼šä¸­å°å‹ç³»ç»Ÿ
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Gateway  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼         â–¼
  Users    Orders    Products</code></pre>
<h4 id="å¤šç½‘å…³æŒ‰å®¢æˆ·ç«¯åˆ†">å¤šç½‘å…³ï¼ˆæŒ‰å®¢æˆ·ç«¯åˆ†ï¼‰</h4>
<pre><code>é€‚ç”¨ï¼šå¤šç«¯åº”ç”¨ï¼ˆWeb/Mobile/ç¬¬ä¸‰æ–¹ï¼‰

  Web Client    Mobile App    Partner API
       â”‚             â”‚             â”‚
       â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web GW   â”‚  â”‚Mobile GW â”‚  â”‚Partner GWâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
            Internal Services</code></pre>
<h4 id="ç½‘å…³-service-mesh">ç½‘å…³ + Service Mesh</h4>
<pre><code>é€‚ç”¨ï¼šå¤§å‹å¾®æœåŠ¡ç³»ç»Ÿ

Client â†’ API Gateway â†’ [Service Mesh (Istio/Linkerd)]
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Sidecar â”‚      â”‚Sidecar â”‚      â”‚Sidecar â”‚
         â”‚   +    â”‚      â”‚   +    â”‚      â”‚   +    â”‚
         â”‚Service â”‚      â”‚Service â”‚      â”‚Service â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<h3 id="ç½‘å…³-vs-service-mesh">2.3 ç½‘å…³ vs Service Mesh</h3>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>API Gateway</th>
<th>Service Mesh</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æµé‡å…¥å£</strong></td>
<td>âœ… å—åŒ—å‘æµé‡</td>
<td>âŒ ä¸»è¦ä¸œè¥¿å‘</td>
</tr>
<tr>
<td><strong>è®¤è¯æˆæƒ</strong></td>
<td>âœ… å¤–éƒ¨è®¤è¯</td>
<td>âœ… æœåŠ¡é—´ mTLS</td>
</tr>
<tr>
<td><strong>é™æµç†”æ–­</strong></td>
<td>âœ… å…¥å£çº§åˆ«</td>
<td>âœ… æœåŠ¡çº§åˆ«</td>
</tr>
<tr>
<td><strong>åè®®è½¬æ¢</strong></td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>è¯·æ±‚èšåˆ</strong></td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>å¯è§‚æµ‹æ€§</strong></td>
<td>âœ… å…¥å£çº§åˆ«</td>
<td>âœ… å…¨é“¾è·¯</td>
</tr>
<tr>
<td><strong>éƒ¨ç½²å¤æ‚åº¦</strong></td>
<td>ä½</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="net-ç½‘å…³å®ç°æ–¹æ¡ˆ">3. .NET ç½‘å…³å®ç°æ–¹æ¡ˆ</h2>
<h3 id="æ–¹æ¡ˆæ¦‚è§ˆ">3.1 æ–¹æ¡ˆæ¦‚è§ˆ</h3>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ç±»å‹</th>
<th>ç»´æŠ¤è€…</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>YARP</strong></td>
<td>åå‘ä»£ç†åº“</td>
<td>Microsoft</td>
<td>è‡ªå®šä¹‰ç½‘å…³</td>
</tr>
<tr>
<td><strong>Ocelot</strong></td>
<td>API ç½‘å…³æ¡†æ¶</td>
<td>å¼€æºç¤¾åŒº</td>
<td>å¿«é€Ÿæ­å»º</td>
</tr>
<tr>
<td><strong>Azure API Management</strong></td>
<td>äº‘æœåŠ¡</td>
<td>Microsoft</td>
<td>Azure éƒ¨ç½²</td>
</tr>
<tr>
<td><strong>Kong</strong></td>
<td>ç‹¬ç«‹ç½‘å…³</td>
<td>Kong Inc</td>
<td>å¤šè¯­è¨€ç¯å¢ƒ</td>
</tr>
<tr>
<td><strong>è‡ªç ”ï¼ˆASP.NET Coreï¼‰</strong></td>
<td>è‡ªå®šä¹‰</td>
<td>-</td>
<td>ç‰¹æ®Šéœ€æ±‚</td>
</tr>
</tbody>
</table>
<h3 id="yarpyet-another-reverse-proxy">3.2 YARPï¼ˆYet Another Reverse
Proxyï¼‰</h3>
<p><strong>åŒ…</strong>: <code>Yarp.ReverseProxy</code></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Program.cs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> builder <span class="op">=</span> WebApplication<span class="op">.</span><span class="fu">CreateBuilder</span><span class="op">(</span>args<span class="op">);</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddReverseProxy</span><span class="op">()</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">LoadFromConfig</span><span class="op">(</span>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">GetSection</span><span class="op">(</span><span class="st">&quot;ReverseProxy&quot;</span><span class="op">));</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> app <span class="op">=</span> builder<span class="op">.</span><span class="fu">Build</span><span class="op">();</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">MapReverseProxy</span><span class="op">();</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">Run</span><span class="op">();</span></span></code></pre></div>
<p><strong>appsettings.json</strong>:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;ReverseProxy&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Routes&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;api-route&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ClusterId&quot;</span><span class="fu">:</span> <span class="st">&quot;api-cluster&quot;</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Match&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Path&quot;</span><span class="fu">:</span> <span class="st">&quot;/api/{**catch-all}&quot;</span> <span class="fu">},</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Transforms&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span> <span class="dt">&quot;PathRemovePrefix&quot;</span><span class="fu">:</span> <span class="st">&quot;/api&quot;</span> <span class="fu">}</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Clusters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;api-cluster&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;LoadBalancingPolicy&quot;</span><span class="fu">:</span> <span class="st">&quot;RoundRobin&quot;</span><span class="fu">,</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;HealthCheck&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;Active&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Interval&quot;</span><span class="fu">:</span> <span class="st">&quot;00:00:10&quot;</span><span class="fu">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Path&quot;</span><span class="fu">:</span> <span class="st">&quot;/health&quot;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Destinations&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;d1&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Address&quot;</span><span class="fu">:</span> <span class="st">&quot;http://backend-1:5000&quot;</span> <span class="fu">},</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;d2&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Address&quot;</span><span class="fu">:</span> <span class="st">&quot;http://backend-2:5000&quot;</span> <span class="fu">}</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>è‡ªå®šä¹‰ä¸­é—´ä»¶</strong>:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddReverseProxy</span><span class="op">()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">LoadFromConfig</span><span class="op">(</span>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">GetSection</span><span class="op">(</span><span class="st">&quot;ReverseProxy&quot;</span><span class="op">))</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddTransforms</span><span class="op">(</span>context <span class="op">=&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// æ·»åŠ è¯·æ±‚å¤´</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">AddRequestHeader</span><span class="op">(</span><span class="st">&quot;X-Forwarded-Host&quot;</span><span class="op">,</span> context<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">Host</span><span class="op">.</span><span class="fu">Value</span><span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// è‡ªå®šä¹‰è½¬æ¢</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">AddRequestTransform</span><span class="op">(</span>async transformContext <span class="op">=&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> userId <span class="op">=</span> transformContext<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">User</span><span class="op">.</span><span class="fu">FindFirst</span><span class="op">(</span><span class="st">&quot;sub&quot;</span><span class="op">)?.</span><span class="fu">Value</span><span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>userId <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                transformContext<span class="op">.</span><span class="fu">ProxyRequest</span><span class="op">.</span><span class="fu">Headers</span><span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="st">&quot;X-User-Id&quot;</span><span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span></code></pre></div>
<h3 id="ocelot">3.3 Ocelot</h3>
<p><strong>åŒ…</strong>: <code>Ocelot</code></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Program.cs</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> builder <span class="op">=</span> WebApplication<span class="op">.</span><span class="fu">CreateBuilder</span><span class="op">(</span>args<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">AddJsonFile</span><span class="op">(</span><span class="st">&quot;ocelot.json&quot;</span><span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddOcelot</span><span class="op">();</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> app <span class="op">=</span> builder<span class="op">.</span><span class="fu">Build</span><span class="op">();</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>await app<span class="op">.</span><span class="fu">UseOcelot</span><span class="op">();</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">Run</span><span class="op">();</span></span></code></pre></div>
<p><strong>ocelot.json</strong>:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;Routes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/api/users/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamScheme&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span><span class="fu">,</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamHostAndPorts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;Host&quot;</span><span class="fu">:</span> <span class="st">&quot;users-service&quot;</span><span class="fu">,</span> <span class="dt">&quot;Port&quot;</span><span class="fu">:</span> <span class="dv">5001</span> <span class="fu">}</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;UpstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/users/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;UpstreamHttpMethod&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;Get&quot;</span><span class="ot">,</span> <span class="st">&quot;Post&quot;</span><span class="ot">,</span> <span class="st">&quot;Put&quot;</span><span class="ot">,</span> <span class="st">&quot;Delete&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AuthenticationOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;AuthenticationProviderKey&quot;</span><span class="fu">:</span> <span class="st">&quot;Bearer&quot;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;RateLimitOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;EnableRateLimiting&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Period&quot;</span><span class="fu">:</span> <span class="st">&quot;1s&quot;</span><span class="fu">,</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Limit&quot;</span><span class="fu">:</span> <span class="dv">100</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/api/orders/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamScheme&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span><span class="fu">,</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamHostAndPorts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;Host&quot;</span><span class="fu">:</span> <span class="st">&quot;orders-service&quot;</span><span class="fu">,</span> <span class="dt">&quot;Port&quot;</span><span class="fu">:</span> <span class="dv">5002</span> <span class="fu">}</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;UpstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/orders/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;LoadBalancerOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Type&quot;</span><span class="fu">:</span> <span class="st">&quot;RoundRobin&quot;</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;GlobalConfiguration&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;BaseUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.example.com&quot;</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>æœåŠ¡å‘ç°ï¼ˆConsulï¼‰</strong>:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddOcelot</span><span class="op">()</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddConsul</span><span class="op">();</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;Routes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/api/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;DownstreamScheme&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span><span class="fu">,</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;UpstreamPathTemplate&quot;</span><span class="fu">:</span> <span class="st">&quot;/users/{everything}&quot;</span><span class="fu">,</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ServiceName&quot;</span><span class="fu">:</span> <span class="st">&quot;users-service&quot;</span><span class="fu">,</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;LoadBalancerOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Type&quot;</span><span class="fu">:</span> <span class="st">&quot;RoundRobin&quot;</span> <span class="fu">}</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;GlobalConfiguration&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;ServiceDiscoveryProvider&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Scheme&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span><span class="fu">,</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Host&quot;</span><span class="fu">:</span> <span class="st">&quot;consul&quot;</span><span class="fu">,</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Port&quot;</span><span class="fu">:</span> <span class="dv">8500</span><span class="fu">,</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Type&quot;</span><span class="fu">:</span> <span class="st">&quot;Consul&quot;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="è‡ªç ”ç½‘å…³asp.net-core">3.4 è‡ªç ”ç½‘å…³ï¼ˆASP.NET Coreï¼‰</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ç®€å•åå‘ä»£ç†å®ç°</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProxyMiddleware</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> RequestDelegate _next<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IHttpClientFactory _clientFactory<span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IServiceDiscovery _discovery<span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ProxyMiddleware</span><span class="op">(</span>RequestDelegate next<span class="op">,</span> IHttpClientFactory clientFactory<span class="op">,</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        IServiceDiscovery discovery<span class="op">)</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        _next <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        _clientFactory <span class="op">=</span> clientFactory<span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        _discovery <span class="op">=</span> discovery<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">InvokeAsync</span><span class="op">(</span>HttpContext context<span class="op">)</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> path <span class="op">=</span> context<span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">Path</span><span class="op">.</span><span class="fu">Value</span><span class="op">;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// è·¯ç”±åŒ¹é…</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> service <span class="op">=</span> <span class="fu">ResolveService</span><span class="op">(</span>path<span class="op">);</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>service <span class="op">==</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            await <span class="fu">_next</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span><span class="op">;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// æœåŠ¡å‘ç°</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> endpoint <span class="op">=</span> await _discovery<span class="op">.</span><span class="fu">GetEndpointAsync</span><span class="op">(</span>service<span class="op">);</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// è½¬å‘è¯·æ±‚</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> client <span class="op">=</span> _clientFactory<span class="op">.</span><span class="fu">CreateClient</span><span class="op">();</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> request <span class="op">=</span> <span class="fu">CreateProxyRequest</span><span class="op">(</span>context<span class="op">,</span> endpoint<span class="op">);</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> response <span class="op">=</span> await client<span class="op">.</span><span class="fu">SendAsync</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¤åˆ¶å“åº”</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">CopyResponseAsync</span><span class="op">(</span>context<span class="op">,</span> response<span class="op">);</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> HttpRequestMessage <span class="fu">CreateProxyRequest</span><span class="op">(</span>HttpContext context<span class="op">,</span> <span class="dt">string</span> endpoint<span class="op">)</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> request <span class="op">=</span> <span class="kw">new</span> HttpRequestMessage</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>            Method <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpMethod</span><span class="op">(</span>context<span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">Method</span><span class="op">),</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>            RequestUri <span class="op">=</span> <span class="kw">new</span> <span class="fu">Uri</span><span class="op">(</span>$<span class="st">&quot;{endpoint}{context.Request.Path}{context.Request.QueryString}&quot;</span><span class="op">)</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¤åˆ¶è¯·æ±‚å¤´</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> header <span class="kw">in</span> context<span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">Headers</span><span class="op">)</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>            request<span class="op">.</span><span class="fu">Headers</span><span class="op">.</span><span class="fu">TryAddWithoutValidation</span><span class="op">(</span>header<span class="op">.</span><span class="fu">Key</span><span class="op">,</span> header<span class="op">.</span><span class="fu">Value</span><span class="op">.</span><span class="fu">ToArray</span><span class="op">());</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// å¤åˆ¶è¯·æ±‚ä½“</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>context<span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">ContentLength</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>            request<span class="op">.</span><span class="fu">Content</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">StreamContent</span><span class="op">(</span>context<span class="op">.</span><span class="fu">Request</span><span class="op">.</span><span class="fu">Body</span><span class="op">);</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> request<span class="op">;</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="net-ç½‘å…³æ¡†æ¶å¯¹æ¯”">4. .NET ç½‘å…³æ¡†æ¶å¯¹æ¯”</h2>
<h3 id="åŠŸèƒ½å¯¹æ¯”">4.1 åŠŸèƒ½å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th style="text-align: center;">YARP</th>
<th style="text-align: center;">Ocelot</th>
<th style="text-align: center;">Azure APIM</th>
<th style="text-align: center;">Kong</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>è·¯ç”±</strong></td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>è´Ÿè½½å‡è¡¡</strong></td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>å¥åº·æ£€æŸ¥</strong></td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>é™æµ</strong></td>
<td style="text-align: center;">éœ€æ‰©å±•</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>ç†”æ–­</strong></td>
<td style="text-align: center;">éœ€æ‰©å±•</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>è®¤è¯</strong></td>
<td style="text-align: center;">éœ€é›†æˆ</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>è¯·æ±‚èšåˆ</strong></td>
<td style="text-align: center;">âŒ</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">æ’ä»¶</td>
</tr>
<tr>
<td><strong>æœåŠ¡å‘ç°</strong></td>
<td style="text-align: center;">éœ€æ‰©å±•</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>ç¼“å­˜</strong></td>
<td style="text-align: center;">éœ€æ‰©å±•</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>WebSocket</strong></td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>gRPC</strong></td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âŒ</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
<tr>
<td><strong>ç®¡ç† UI</strong></td>
<td style="text-align: center;">âŒ</td>
<td style="text-align: center;">âŒ</td>
<td style="text-align: center;">âœ…</td>
<td style="text-align: center;">âœ…</td>
</tr>
</tbody>
</table>
<h3 id="æ€§èƒ½å¯¹æ¯”">4.2 æ€§èƒ½å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th style="text-align: center;">YARP</th>
<th style="text-align: center;">Ocelot</th>
<th style="text-align: center;">Kong</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ååé‡</strong></td>
<td style="text-align: center;">â­â­â­â­â­</td>
<td style="text-align: center;">â­â­â­</td>
<td style="text-align: center;">â­â­â­â­</td>
</tr>
<tr>
<td><strong>å»¶è¿Ÿ</strong></td>
<td style="text-align: center;">&lt; 1ms</td>
<td style="text-align: center;">2-5ms</td>
<td style="text-align: center;">1-2ms</td>
</tr>
<tr>
<td><strong>å†…å­˜å ç”¨</strong></td>
<td style="text-align: center;">ä½</td>
<td style="text-align: center;">ä¸­</td>
<td style="text-align: center;">é«˜</td>
</tr>
<tr>
<td><strong>CPU å ç”¨</strong></td>
<td style="text-align: center;">ä½</td>
<td style="text-align: center;">ä¸­</td>
<td style="text-align: center;">ä¸­</td>
</tr>
</tbody>
</table>
<blockquote>
<p>YARP æ˜¯ç›®å‰ .NET ç”Ÿæ€ä¸­æ€§èƒ½æœ€å¥½çš„æ–¹æ¡ˆï¼Œå¾®è½¯å†…éƒ¨æœåŠ¡å¤§é‡ä½¿ç”¨ã€‚</p>
</blockquote>
<h3 id="ä¼˜åŠ£åŠ¿å¯¹æ¯”">4.3 ä¼˜åŠ£åŠ¿å¯¹æ¯”</h3>
<h4 id="yarp">YARP</h4>
<table>
<thead>
<tr>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>âœ… å¾®è½¯å®˜æ–¹ç»´æŠ¤ï¼Œé•¿æœŸæ”¯æŒ</td>
<td>âŒ åŠŸèƒ½éœ€è¦è‡ªå·±æ‰©å±•</td>
</tr>
<tr>
<td>âœ… æ€§èƒ½æä½³</td>
<td>âŒ æ²¡æœ‰å†…ç½®é™æµ/ç†”æ–­</td>
</tr>
<tr>
<td>âœ… é«˜åº¦å¯å®šåˆ¶</td>
<td>âŒ å­¦ä¹ æ›²çº¿ç¨é«˜</td>
</tr>
<tr>
<td>âœ… æ”¯æŒ gRPC/WebSocket</td>
<td>âŒ æ— ç®¡ç†ç•Œé¢</td>
</tr>
<tr>
<td>âœ… ä¸ ASP.NET Core æ·±åº¦é›†æˆ</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="ocelot-1">Ocelot</h4>
<table>
<thead>
<tr>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>âœ… å¼€ç®±å³ç”¨ï¼ŒåŠŸèƒ½å®Œæ•´</td>
<td>âŒ æ€§èƒ½ä¸å¦‚ YARP</td>
</tr>
<tr>
<td>âœ… é…ç½®ç®€å•</td>
<td>âŒ ä¸æ”¯æŒ gRPC</td>
</tr>
<tr>
<td>âœ… å†…ç½®é™æµ/ç†”æ–­/ç¼“å­˜</td>
<td>âŒ ç¤¾åŒºæ´»è·ƒåº¦ä¸‹é™</td>
</tr>
<tr>
<td>âœ… æ”¯æŒæœåŠ¡å‘ç°ï¼ˆConsul/Eurekaï¼‰</td>
<td>âŒ æ‰©å±•æ€§æœ‰é™</td>
</tr>
<tr>
<td>âœ… æ–‡æ¡£å®Œå–„</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="azure-api-management">Azure API Management</h4>
<table>
<thead>
<tr>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>âœ… å®Œæ•´çš„ç®¡ç†ç•Œé¢</td>
<td>âŒ æˆæœ¬è¾ƒé«˜</td>
</tr>
<tr>
<td>âœ… å¼€å‘è€…é—¨æˆ·</td>
<td>âŒ ä»…é™ Azure</td>
</tr>
<tr>
<td>âœ… æ‰˜ç®¡æœåŠ¡ï¼Œæ— éœ€è¿ç»´</td>
<td>âŒ å†·å¯åŠ¨å»¶è¿Ÿ</td>
</tr>
<tr>
<td>âœ… å†…ç½®åˆ†æå’Œç›‘æ§</td>
<td>âŒ è‡ªå®šä¹‰å—é™</td>
</tr>
<tr>
<td>âœ… ç‰ˆæœ¬ç®¡ç†ã€API æ–‡æ¡£</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="kong">Kong</h4>
<table>
<thead>
<tr>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>âœ… è¯­è¨€æ— å…³ï¼Œå¤šç¯å¢ƒéƒ¨ç½²</td>
<td>âŒ ä¸æ˜¯ .NET åŸç”Ÿ</td>
</tr>
<tr>
<td>âœ… ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€</td>
<td>âŒ éƒ¨ç½²å¤æ‚ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰</td>
</tr>
<tr>
<td>âœ… ä¼ä¸šç‰ˆåŠŸèƒ½å¼ºå¤§</td>
<td>âŒ ä¼ä¸šç‰ˆæ”¶è´¹</td>
</tr>
<tr>
<td>âœ… ç®¡ç†ç•Œé¢</td>
<td>âŒ ä¸ .NET é›†æˆä¸å¦‚åŸç”Ÿæ–¹æ¡ˆ</td>
</tr>
</tbody>
</table>
<h3 id="é€‰å‹å»ºè®®">4.4 é€‰å‹å»ºè®®</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨èæ–¹æ¡ˆ</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>é«˜æ€§èƒ½éœ€æ±‚</strong></td>
<td>YARP</td>
<td>æ€§èƒ½æœ€ä½³ï¼Œå®˜æ–¹æ”¯æŒ</td>
</tr>
<tr>
<td><strong>å¿«é€Ÿæ­å»º</strong></td>
<td>Ocelot</td>
<td>åŠŸèƒ½å®Œæ•´ï¼Œé…ç½®ç®€å•</td>
</tr>
<tr>
<td><strong>Azure éƒ¨ç½²</strong></td>
<td>Azure APIM</td>
<td>æ‰˜ç®¡æœåŠ¡ï¼Œæ— éœ€è¿ç»´</td>
</tr>
<tr>
<td><strong>å¤šè¯­è¨€å¾®æœåŠ¡</strong></td>
<td>Kong</td>
<td>è¯­è¨€æ— å…³ï¼Œæ’ä»¶ä¸°å¯Œ</td>
</tr>
<tr>
<td><strong>æ·±åº¦å®šåˆ¶</strong></td>
<td>YARP + è‡ªå®šä¹‰æ‰©å±•</td>
<td>å¯æ§æ€§æœ€å¼º</td>
</tr>
<tr>
<td><strong>ä¸­å°å‹é¡¹ç›®</strong></td>
<td>Ocelot</td>
<td>å¤Ÿç”¨ä¸”ç®€å•</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="äº‘éƒ¨ç½²ç½‘å…³è®¾è®¡æ³¨æ„äº‹é¡¹">5. äº‘éƒ¨ç½²ç½‘å…³è®¾è®¡æ³¨æ„äº‹é¡¹</h2>
<h3 id="é«˜å¯ç”¨è®¾è®¡">5.1 é«˜å¯ç”¨è®¾è®¡</h3>
<pre><code>                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancer  â”‚
                    â”‚   (Azure LB /   â”‚
                    â”‚    AWS ALB)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Gateway    â”‚ â”‚   Gateway    â”‚ â”‚   Gateway    â”‚
    â”‚  (Zone A)    â”‚ â”‚  (Zone B)    â”‚ â”‚  (Zone C)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<p><strong>å…³é”®ç‚¹</strong>ï¼š - âœ… å¤šå®ä¾‹éƒ¨ç½²ï¼Œè·¨å¯ç”¨åŒº - âœ…
æ— çŠ¶æ€è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±• - âœ… å¥åº·æ£€æŸ¥é…ç½® - âœ… ä¼šè¯ä¿æŒï¼ˆå¦‚éœ€è¦ï¼‰</p>
<h3 id="å®‰å…¨è®¾è®¡">5.2 å®‰å…¨è®¾è®¡</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. HTTPS å¼ºåˆ¶</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">UseHttpsRedirection</span><span class="op">();</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">UseHsts</span><span class="op">();</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. è¯·æ±‚å¤´å®‰å…¨</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">Use</span><span class="op">(</span><span class="fu">async</span> <span class="op">(</span>context<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">Headers</span><span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="st">&quot;X-Content-Type-Options&quot;</span><span class="op">,</span> <span class="st">&quot;nosniff&quot;</span><span class="op">);</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">Headers</span><span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="st">&quot;X-Frame-Options&quot;</span><span class="op">,</span> <span class="st">&quot;DENY&quot;</span><span class="op">);</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">Headers</span><span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="st">&quot;X-XSS-Protection&quot;</span><span class="op">,</span> <span class="st">&quot;1; mode=block&quot;</span><span class="op">);</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    await <span class="fu">next</span><span class="op">();</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. IP ç™½åå•ï¼ˆå†…éƒ¨æœåŠ¡ï¼‰</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddReverseProxy</span><span class="op">()</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddTransforms</span><span class="op">(</span>context <span class="op">=&gt;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">AddRequestTransform</span><span class="op">(</span>async transformContext <span class="op">=&gt;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> clientIp <span class="op">=</span> transformContext<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">Connection</span><span class="op">.</span><span class="fu">RemoteIpAddress</span><span class="op">;</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(!</span><span class="fu">IsAllowedIp</span><span class="op">(</span>clientIp<span class="op">))</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>                transformContext<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">StatusCode</span> <span class="op">=</span> <span class="dv">403</span><span class="op">;</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span><span class="op">;</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">// 4. è¯·æ±‚å¤§å°é™åˆ¶</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">WebHost</span><span class="op">.</span><span class="fu">ConfigureKestrel</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">Limits</span><span class="op">.</span><span class="fu">MaxRequestBodySize</span> <span class="op">=</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// 10MB</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h3 id="é™æµä¸ç†”æ–­-1">5.3 é™æµä¸ç†”æ–­</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ä½¿ç”¨ ASP.NET Core Rate Limiting (.NET 7+)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddRateLimiter</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// å…¨å±€é™æµ</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">GlobalLimiter</span> <span class="op">=</span> PartitionedRateLimiter<span class="op">.</span><span class="fu">Create</span><span class="op">&lt;</span>HttpContext<span class="op">,</span> <span class="dt">string</span><span class="op">&gt;(</span>context <span class="op">=&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        RateLimitPartition<span class="op">.</span><span class="fu">GetFixedWindowLimiter</span><span class="op">(</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            partitionKey<span class="op">:</span> context<span class="op">.</span><span class="fu">Connection</span><span class="op">.</span><span class="fu">RemoteIpAddress</span><span class="op">?.</span><span class="fu">ToString</span><span class="op">()</span> <span class="op">??</span> <span class="st">&quot;unknown&quot;</span><span class="op">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            factory<span class="op">:</span> _ <span class="op">=&gt;</span> <span class="kw">new</span> FixedWindowRateLimiterOptions</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                PermitLimit <span class="op">=</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                Window <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                QueueLimit <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}));</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// æŒ‰è·¯ç”±é™æµ</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">AddPolicy</span><span class="op">(</span><span class="st">&quot;api&quot;</span><span class="op">,</span> context <span class="op">=&gt;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        RateLimitPartition<span class="op">.</span><span class="fu">GetSlidingWindowLimiter</span><span class="op">(</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            partitionKey<span class="op">:</span> context<span class="op">.</span><span class="fu">User</span><span class="op">.</span><span class="fu">Identity</span><span class="op">?.</span><span class="fu">Name</span> <span class="op">??</span> <span class="st">&quot;anonymous&quot;</span><span class="op">,</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            factory<span class="op">:</span> _ <span class="op">=&gt;</span> <span class="kw">new</span> SlidingWindowRateLimiterOptions</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                PermitLimit <span class="op">=</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                Window <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>                SegmentsPerWindow <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}));</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">OnRejected</span> <span class="op">=</span> <span class="fu">async</span> <span class="op">(</span>context<span class="op">,</span> token<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">StatusCode</span> <span class="op">=</span> <span class="dv">429</span><span class="op">;</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        await context<span class="op">.</span><span class="fu">HttpContext</span><span class="op">.</span><span class="fu">Response</span><span class="op">.</span><span class="fu">WriteAsJsonAsync</span><span class="op">(</span><span class="kw">new</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>            error <span class="op">=</span> <span class="st">&quot;Too many requests&quot;</span><span class="op">,</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>            retryAfter <span class="op">=</span> context<span class="op">.</span><span class="fu">Lease</span><span class="op">.</span><span class="fu">TryGetMetadata</span><span class="op">(</span>MetadataName<span class="op">.</span><span class="fu">RetryAfter</span><span class="op">,</span> <span class="kw">out</span> <span class="dt">var</span> retryAfter<span class="op">)</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">?</span> retryAfter<span class="op">.</span><span class="fu">TotalSeconds</span> <span class="op">:</span> <span class="dv">60</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> token<span class="op">);</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">UseRateLimiter</span><span class="op">();</span></span></code></pre></div>
<h3 id="å¯è§‚æµ‹æ€§">5.4 å¯è§‚æµ‹æ€§</h3>
<div class="sourceCode" id="cb21"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OpenTelemetry é›†æˆ</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddOpenTelemetry</span><span class="op">()</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithTracing</span><span class="op">(</span>tracing <span class="op">=&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        tracing</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddAspNetCoreInstrumentation</span><span class="op">()</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddHttpClientInstrumentation</span><span class="op">()</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddSource</span><span class="op">(</span><span class="st">&quot;Yarp.ReverseProxy&quot;</span><span class="op">)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddOtlpExporter</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                options<span class="op">.</span><span class="fu">Endpoint</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Uri</span><span class="op">(</span><span class="st">&quot;http://otel-collector:4317&quot;</span><span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">WithMetrics</span><span class="op">(</span>metrics <span class="op">=&gt;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        metrics</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddAspNetCoreInstrumentation</span><span class="op">()</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddHttpClientInstrumentation</span><span class="op">()</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddMeter</span><span class="op">(</span><span class="st">&quot;Yarp.ReverseProxy&quot;</span><span class="op">)</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">AddOtlpExporter</span><span class="op">();</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">// å¥åº·æ£€æŸ¥ç«¯ç‚¹</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddHealthChecks</span><span class="op">()</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddCheck</span><span class="op">(</span><span class="st">&quot;gateway&quot;</span><span class="op">,</span> <span class="op">()</span> <span class="op">=&gt;</span> HealthCheckResult<span class="op">.</span><span class="fu">Healthy</span><span class="op">())</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddRedis</span><span class="op">(</span>redisConnectionString<span class="op">)</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">AddUrlGroup</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Uri</span><span class="op">(</span><span class="st">&quot;http://backend/health&quot;</span><span class="op">),</span> <span class="st">&quot;backend&quot;</span><span class="op">);</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">MapHealthChecks</span><span class="op">(</span><span class="st">&quot;/health&quot;</span><span class="op">,</span> <span class="kw">new</span> HealthCheckOptions</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    ResponseWriter <span class="op">=</span> UIResponseWriter<span class="op">.</span><span class="fu">WriteHealthCheckUIResponse</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h3 id="é…ç½®ç®¡ç†">5.5 é…ç½®ç®¡ç†</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// åŠ¨æ€é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddReverseProxy</span><span class="op">()</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">LoadFromConfig</span><span class="op">(</span>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">GetSection</span><span class="op">(</span><span class="st">&quot;ReverseProxy&quot;</span><span class="op">))</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">ConfigureHttpClient</span><span class="op">((</span>context<span class="op">,</span> handler<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// è‡ªå®šä¹‰ HttpClient</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        handler<span class="op">.</span><span class="fu">SslOptions</span><span class="op">.</span><span class="fu">RemoteCertificateValidationCallback</span> <span class="op">=</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span>sender<span class="op">,</span> cert<span class="op">,</span> chain<span class="op">,</span> errors<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// ä»…å¼€å‘ç¯å¢ƒ</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">// ä»é…ç½®ä¸­å¿ƒåŠ è½½ï¼ˆå¦‚ Azure App Configurationï¼‰</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">AddAzureAppConfiguration</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">Connect</span><span class="op">(</span>connectionString<span class="op">)</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span><span class="st">&quot;Gateway:*&quot;</span><span class="op">)</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">ConfigureRefresh</span><span class="op">(</span>refresh <span class="op">=&gt;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>            refresh<span class="op">.</span><span class="fu">Register</span><span class="op">(</span><span class="st">&quot;Gateway:Sentinel&quot;</span><span class="op">,</span> refreshAll<span class="op">:</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">SetCacheExpiration</span><span class="op">(</span>TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">));</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h3 id="å®¹å™¨åŒ–éƒ¨ç½²">5.6 å®¹å™¨åŒ–éƒ¨ç½²</h3>
<p><strong>Dockerfile</strong>:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> mcr.microsoft.com/dotnet/aspnet:8.0 <span class="kw">AS</span> base</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 443</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> mcr.microsoft.com/dotnet/sdk:8.0 <span class="kw">AS</span> build</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /src</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> [<span class="st">&quot;Gateway/Gateway.csproj&quot;</span>, <span class="st">&quot;Gateway/&quot;</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">dotnet</span> restore <span class="st">&quot;Gateway/Gateway.csproj&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . .</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> <span class="st">&quot;/src/Gateway&quot;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">dotnet</span> build <span class="at">-c</span> Release <span class="at">-o</span> /app/build</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> build <span class="kw">AS</span> publish</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">dotnet</span> publish <span class="at">-c</span> Release <span class="at">-o</span> /app/publish</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> base <span class="kw">AS</span> final</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=publish</span> /app/publish .</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># å¥åº·æ£€æŸ¥</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="op">--interval=30s</span> <span class="op">--timeout=3s</span> \</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CMD</span> <span class="ex">curl</span> <span class="at">-f</span> http://localhost/health <span class="kw">||</span> <span class="bu">exit</span> 1</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;dotnet&quot;</span>, <span class="st">&quot;Gateway.dll&quot;</span>]</span></code></pre></div>
<p><strong>Kubernetes éƒ¨ç½²</strong>:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> gateway</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> myregistry/api-gateway:latest</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;256Mi&quot;</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;250m&quot;</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;512Mi&quot;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ASPNETCORE_ENVIRONMENT</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Production&quot;</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> autoscaling/v2</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> HorizontalPodAutoscaler</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api-gateway-hpa</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scaleTargetRef</span><span class="kw">:</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api-gateway</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">maxReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics</span><span class="kw">:</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cpu</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">70</span></span></code></pre></div>
<h3 id="äº‘éƒ¨ç½²æ£€æŸ¥æ¸…å•">5.7 äº‘éƒ¨ç½²æ£€æŸ¥æ¸…å•</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              äº‘éƒ¨ç½²ç½‘å…³æ£€æŸ¥æ¸…å•                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  é«˜å¯ç”¨                                                 â”‚
â”‚  â–¡ å¤šå®ä¾‹éƒ¨ç½²ï¼ˆè‡³å°‘ 3 ä¸ªï¼‰                              â”‚
â”‚  â–¡ è·¨å¯ç”¨åŒºåˆ†å¸ƒ                                        â”‚
â”‚  â–¡ å¥åº·æ£€æŸ¥é…ç½®                                        â”‚
â”‚  â–¡ è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥                                      â”‚
â”‚                                                         â”‚
â”‚  å®‰å…¨                                                   â”‚
â”‚  â–¡ HTTPS å¼ºåˆ¶                                          â”‚
â”‚  â–¡ WAF é…ç½®                                            â”‚
â”‚  â–¡ DDoS é˜²æŠ¤                                           â”‚
â”‚  â–¡ è¯·æ±‚å¤§å°é™åˆ¶                                        â”‚
â”‚  â–¡ æ•æ„Ÿä¿¡æ¯è„±æ•                                        â”‚
â”‚                                                         â”‚
â”‚  æ€§èƒ½                                                   â”‚
â”‚  â–¡ é™æµç­–ç•¥                                            â”‚
â”‚  â–¡ ç†”æ–­é™çº§                                            â”‚
â”‚  â–¡ å“åº”ç¼“å­˜                                            â”‚
â”‚  â–¡ è¿æ¥æ± é…ç½®                                          â”‚
â”‚                                                         â”‚
â”‚  å¯è§‚æµ‹                                                 â”‚
â”‚  â–¡ æ—¥å¿—èšåˆ                                            â”‚
â”‚  â–¡ é“¾è·¯è¿½è¸ª                                            â”‚
â”‚  â–¡ æŒ‡æ ‡ç›‘æ§                                            â”‚
â”‚  â–¡ å‘Šè­¦é…ç½®                                            â”‚
â”‚                                                         â”‚
â”‚  è¿ç»´                                                   â”‚
â”‚  â–¡ é…ç½®ä¸­å¿ƒé›†æˆ                                        â”‚
â”‚  â–¡ å¯†é’¥ç®¡ç†ï¼ˆKey Vaultï¼‰                               â”‚
â”‚  â–¡ è“ç»¿/é‡‘ä¸é›€å‘å¸ƒ                                     â”‚
â”‚  â–¡ å›æ»šç­–ç•¥                                            â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<hr />
<h2 id="æ€»ç»“">6. æ€»ç»“</h2>
<h3 id="æ ¸å¿ƒè¦ç‚¹">æ ¸å¿ƒè¦ç‚¹</h3>
<table>
<thead>
<tr>
<th>ä¸»é¢˜</th>
<th>å…³é”®ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç½‘å…³ä½œç”¨</strong></td>
<td>ç»Ÿä¸€å…¥å£ã€å®‰å…¨è¾¹ç•Œã€æµé‡ç®¡æ§ã€ç›‘æ§å®¡è®¡</td>
</tr>
<tr>
<td><strong>æ¨èæ–¹æ¡ˆ</strong></td>
<td>é«˜æ€§èƒ½é€‰ YARPï¼Œå¿«é€Ÿæ­å»ºé€‰ Ocelotï¼ŒAzure é€‰ APIM</td>
</tr>
<tr>
<td><strong>äº‘éƒ¨ç½²</strong></td>
<td>å¤šå®ä¾‹ã€è·¨å¯ç”¨åŒºã€é™æµç†”æ–­ã€å¯è§‚æµ‹æ€§</td>
</tr>
<tr>
<td><strong>å®‰å…¨</strong></td>
<td>HTTPSã€WAFã€é™æµã€è¯·æ±‚æ ¡éªŒ</td>
</tr>
</tbody>
</table>
<h3 id="é€‰å‹é€ŸæŸ¥">é€‰å‹é€ŸæŸ¥</h3>
<table>
<thead>
<tr>
<th>éœ€æ±‚</th>
<th>æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ–°é¡¹ç›® + é«˜æ€§èƒ½</td>
<td>YARP</td>
</tr>
<tr>
<td>å¿«é€Ÿæ­å»º + åŠŸèƒ½å®Œæ•´</td>
<td>Ocelot</td>
</tr>
<tr>
<td>Azure äº‘åŸç”Ÿ</td>
<td>Azure API Management</td>
</tr>
<tr>
<td>å¤šè¯­è¨€å¾®æœåŠ¡</td>
<td>Kong</td>
</tr>
</tbody>
</table>
<h3 id="å‚è€ƒèµ„æº">å‚è€ƒèµ„æº</h3>
<ul>
<li><a href="https://microsoft.github.io/reverse-proxy/">YARP
Documentation</a></li>
<li><a href="https://ocelot.readthedocs.io/">Ocelot
Documentation</a></li>
<li><a
href="https://learn.microsoft.com/en-us/azure/api-management/">Azure API
Management</a></li>
<li><a href="https://docs.konghq.com/">Kong Gateway</a></li>
</ul>

                </article>
            </div>
        </section>

        <!-- å³ä¾§çƒ­é—¨æ–‡ç«  -->
        <aside class="popular-sidebar">
            <div class="popular-header">
                <h3>çƒ­é—¨æ–‡ç« </h3>
            </div>
            <div class="popular-list" id="popular-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„çƒ­é—¨æ–‡ç« åˆ—è¡¨ -->
            </div>
        </aside>
    </main>

    <!-- JavaScript -->
    <script type="module" src="/script.js?v=2.2.0"></script>
</body>
</html>