name: Update Navigation Data

# 触发条件：推送到main分支，且修改了notes目录下的文件
on:
  push:
    branches:
      - main
    paths:
      - 'notes/**/*'

# 作业配置
jobs:
  update-nav:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1
      
      # 2. 设置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 3. 运行导航数据生成脚本
      - name: Generate navigation data
        run: python3 generate_nav.py
      
      # 4. 检查是否有更改
      - name: Check for changes
        id: check_changes
        run: |
          git status
          if git diff --exit-code nav_data.json; then
            echo "nav_data.json未更改，跳过提交"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "nav_data.json已更改，准备提交"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # 5. 提交更改
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add nav_data.json
          git commit -m "自动更新导航数据"
          git push origin main
      
      # 6. 输出结果
      - name: Show result
        run: echo "导航数据更新作业完成"